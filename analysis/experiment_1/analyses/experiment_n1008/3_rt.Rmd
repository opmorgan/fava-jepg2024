---
title: "Experiment 1: Reaction Time Analyses"
pagetitle: "exp 1 | RT analyses"
author: "Owen Morgan"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

<style type="text/css">
  body{
  font-family: Avenir;
  font-size: 12pt;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.align = "center", fig.width = 9,
                      fig.height = 6, results = "asis")
options(knitr.kable.NA = "")

cli.progress_show_after <- 0

## Do not use scientific notation until 9 decimal places.
options(scipen = 9, digits = 9)

# Suppress summarise info
options(dplyr.summarise.inform = FALSE)
```

```{r lib}
library(here)
library(tidyverse)
library(cli) # For printing error messages

library(lme4)
library(emmeans)
library(broom)
library(gt)

library(ggpubr) ## functions for plotting SD, SEM, CI.
library(ggbeeswarm)
library(patchwork)
library(ggh4x) ## for nested facets

library(knitr) # For include_graphics

source(here::here("lib", "util.R")) # interaction_stats, ...
source(here::here("lib", "demographics.R"))
source(here::here("lib", "plots-jepg.R"))

EXPERIMENT_DIR <- "experiment_1"
source(here::here(EXPERIMENT_DIR, "lib", "load_process", "load_process.R"))
source(here::here(EXPERIMENT_DIR, "lib", "shape_stats.R")) 

## Colors for plots
plot_blue <- c("#337aB7")
plot_colors <- c("#4477AA",
                 "#EE6677",
                 "#CCBB44",
                 "#66CCEE",
                 "#AA3377",
                 "#228833",
                 "#BBBBBB")
```

```{r config}
proc_dir <- set_or_make_dir(label = "proc",
  here::here(EXPERIMENT_DIR, "data", "proc_exp_n1008")
)
fig_dir <- set_or_make_dir(label = "fig",
  here::here(EXPERIMENT_DIR, "figures")
)
manual_cache_dir <- set_or_make_dir(label = "manual cache",
 here::here(EXPERIMENT_DIR, "manual_cache", "exp_n1008")
)

experiment_label <- "Experiment 1"

## Emmeans settings (use Satterthwaire approx. instead of default t-to-z for large df)
## See: Luke (2017). Evaluating significance in linear mixed-effects models in R
DF_METHOD <- "satterthwaite"
LMERTEST_LIMIT <- 500000

## Figure settings
DEFAULT_HEIGHT = 3
DEFAULT_WIDTH = 5

use_cached_models <- T
use_cached_figs <- T
use_cached_proc_data <- T
```

# {.tabset}
```{r load_data}
## Load "the data" with all subjects & trials.
aah_long <- load_aah_long(proc_dir)

## Load summary data table (for quick demographic analyses)
## with all subjects.
aah_summary_all <- load_aah_summary(proc_dir)
```

```{r prepare_data}
#### PREPARE SUMMARY DATA FOR DEMOGRAPHICS ANALYSES (NAVON EXCLUSIONS)
## Difference from Exp 2 2x_jepg_rt:
## Exp 2 aah_summary_all has the fields "exclude" and "exclude_dl"
## Exp 1 aah_summary_all has the field "exclude"
## Find & replace "excelude_navon" with "exclude"
if (use_cached_proc_data == FALSE) {
cli::cli_alert_info("Filtering summary data for analysis (no excluded subjects).")
cli::cli_bullets(c(" " = "aah_summary_all -> aah_summary"))
aah_summary <- aah_summary_all |>
    filter(exclude == 0) |>
    select(-starts_with("exclude")) |> 
  mutate(
    handedness_extremes = case_when(ehi == -100 ~ "Left",
                                    ehi == 100 ~ "Right",
                                    ehi > -100 & ehi < 100 ~ "Mixed")
  )
  saveRDS(aah_summary, here(manual_cache_dir, "aah_summary.rds"))
} else {
  aah_summary <- readRDS(here(manual_cache_dir, "aah_summary.rds"))
}

#### PREPARE TRIAL-LEVEL DATA FOR RT, ACCURACY ANALYSES
## Prepare "the data" (aah_long) for all analyses:
## Filter out practice trials, absent trials, and excluded subjects
## This data (all present trials, correct or incorrect) will be used for
## accuracy analyses
if (use_cached_proc_data == FALSE) {
cli::cli_alert_info("Filtering long navon data for analysis (no excluded subjects; experimental trials (not practice) only; target present only).")
aah <- aah_long |>
  filter(exclude == 0) |>
  filter(block_type == "main" & target_present == "yes") |>
  select(-starts_with("exclude")) |>
  ## Recode "level", "target" for nicer printing.
  mutate(level = recode(level, global = "Global", local = "Local")) |>
  mutate(target = recode(target, square = "Square", rectangle = "Rectangle")) |>
  ## Code handedness extremes
  mutate(
    handedness_extremes = case_when(ehi == -100 ~ "Left",
                                    ehi == 100 ~ "Right",
                                    ehi > -100 & ehi < 100 ~ "Mixed")
    )
  saveRDS(aah, here(manual_cache_dir, "aah.rds"))
} else {
  aah <- readRDS(here(manual_cache_dir, "aah.rds"))
}

## For RT analyses, prepare dataset with only correct, present trials.
## In our RT model, we only care about correct responses to present trials.
if (use_cached_proc_data == FALSE) {
aah_correct <- aah |> filter(correct == T)
  saveRDS(aah_correct, here(manual_cache_dir, "aah_correct.rds"))
} else {
  aah_correct <- readRDS(here(manual_cache_dir, "aah_correct.rds"))
}

## Relevel field and level with RVF first (unintuitive for plotting),
## so that emmeans will show a positive number for LVF global bias.
if (use_cached_proc_data == FALSE) {
aah_for_rt_model <- aah_correct |>
  mutate(level = level |> factor(levels = c("Global", "Local")),
         field = field |> factor(levels = c("RVF", "LVF")))
  saveRDS(aah_for_rt_model, here(manual_cache_dir, "aah_for_rt_model.rds"))
} else {
  aah_for_rt_model <- readRDS(here(manual_cache_dir, "aah_for_rt_model.rds"))
}

## For accuracy analyses, prepare dataset will all present trials.
## Relevel field and level,
## so that emmeans will show a positive number for LVF global bias.
if (use_cached_proc_data == FALSE) {
aah_for_acc_model <- aah |>
  mutate(level = level |> factor(levels = c("Global", "Local")),
         field = field |> factor(levels = c("RVF", "LVF")))
  saveRDS(aah_for_acc_model, here(manual_cache_dir, "aah_for_acc_model.rds"))
} else {
  aah_for_acc_model <- readRDS(here(manual_cache_dir, "aah_for_acc_model.rds"))
}

#### PREPARE SUBJECT_LEVEL DATA FOR RT, ACCURACY ANALYSES
## Prepare subject-level data (RT)
if (use_cached_proc_data == FALSE) {
rt_subject <- aah_correct |> group_by(subject, field, level, handedness) |>
  summarize(rt = median(rt))
  saveRDS(rt_subject, here(manual_cache_dir, "rt_subject.rds"))
} else {
  rt_subject <- readRDS(here(manual_cache_dir, "rt_subject.rds"))
}


## Prepare subject-level LVF Global bias summary (RT)
if (use_cached_proc_data == FALSE) {
rt_1 <- rt_subject |>
  pivot_wider(names_from = c(field, level),
              values_from = rt) |>
  mutate(LVF_Global_Bias = (RVF_Global - RVF_Local) - (LVF_Global - LVF_Local)) |>
  mutate(all_one_group = "all_one_group")
  saveRDS(rt_1, here(manual_cache_dir, "rt_1.rds"))
} else {
  rt_1 <- readRDS(here(manual_cache_dir, "rt_1.rds"))
}

## Prepare subject-level LVF Global bias summary (Accuracy)
## (For accuracy, include incorrect trials!)
if (use_cached_proc_data == FALSE) {
acc_subject <- aah |> group_by(subject, field, level, handedness, sample, sample2) |>
  summarize(
    total_responses = n(),
    n_present_resp = sum(correct),
    n_absent_resp = total_responses - n_present_resp,
    n_correct = sum(correct),
    acc = 100 * (n_correct / total_responses)
  ) |>
  select(subject, field, level, acc, handedness, sample, sample2) |>
  mutate(level = recode(level, global = "Global", local = "Local"))
  saveRDS(acc_subject, here(manual_cache_dir, "acc_subject.rds"))
} else {
  acc_subject <- readRDS(here(manual_cache_dir, "acc_subject.rds"))
}

if (use_cached_proc_data == FALSE) {
acc_1 <- acc_subject |>
  pivot_wider(names_from = c(field, level),
              values_from = acc) |>
  mutate(LVF_Global_Bias = (LVF_Global - LVF_Local) - (RVF_Global - RVF_Local)) |>
  mutate(all_one_group = "all_one_group")
  saveRDS(acc_1, here(manual_cache_dir, "acc_1.rds"))
} else {
  acc_1 <- readRDS(here(manual_cache_dir, "acc_1.rds"))
}
```

## Demographics {.tabset .tabset-pills}

Demographics for all included participants.
<br>
```{r demo_summary}
rt_demo <- demo_summary_table(aah_summary)
rt_demo |> pretty_table() |> tab_header(title = "Demographics", subtitle = "Summary")
```
<br>

```{r}
hand_demo_summary_table(aah_summary) |> pretty_table() |>
  tab_footnote("Left: (EHI <= -40)  |  Mixed: (-40 < EHI < 40)  |  Right: (EHI >= 40)")
```
<br>
```{r ehi_distribution_plot_purple1}
middle_purple1 <- "#996F91" ## In between plot colors one and two
fig_path_var <- here(fig_dir, "demo_ehi_dots_purple.png")

if (use_cached_figs == F) {
  ehi_plot_data <- aah_summary |> group_by(ehi) |> summarize(n = n())
  g <- gg_ehi_dotarea(ehi_plot_data, plot_color = middle_purple1,
                      cutoff = 40, cutoff_label_ypos = 120)
  ggsave(fig_path_var, g, "png", height = 3, width = 6)
}

include_graphics(fig_path_var)
```


## Categorical handedness (primary) {.tabset .tabset-pills}

### Summary

For reaction time, LVF global>local bias was significantly reduced in left handers (\textit{n} = 331, EHI <= -40) compared to right handers (\textit{n }= 378, EHI >= +40; difference between groups = 11.67ms, 95\% CI [0.65, 22.69], $\chi^2(1)$ = 4.31, \textit{p} = .038, two-sided). Both groups showed significant LVF global>local bias: for right handers, the effect size was 27.31ms (95\% CI [19.78, 34.83],\textit{t}(85,499.1) = 7.11, \textit{p} = < .0001, two-sided); for left handers, 15.64ms (95\% CI [7.60, 23.69], \textit{t}(85,499.4) = 3.81, \textit{p} = .001, two-sided).

Within the local level, right and left handers showed reversed hemifield bias, in the direction predicted by AAH: right handers responded faster to local stimuli in the RVF than LVF by 12.28ms (95\% CI [6.93, 17.63], \textit{t}(85,499.3) = 4.50, \textit{p} < .0001, two-sided), whereas left handers responded faster to local stimuli in the LVF than RVF by 9.65ms (95\% CI [3.91, 15.39], \textit{t}(85,499.7 = 3.30, \textit{p} = .001, two-sided; difference = 21.94ms, 95\% CI [14.01, 29.79], \textit{t}(85,499.5) = 5.48, \textit{p} < .0001, two-sided). 

### Stats
Reaction time is modeled as a linear effect of field, level, and handedness, using data from every target-present trial with a "go" response:
<br>
<br>
`lmer( rt ~ field*level*handedness + (1 | subject) )`
<br>
<br>
```{r rt_model_2bins}
#### FxLxH (prepare model)
## Make a model with two handedness bins: Right and Left
if (use_cached_models == FALSE) {
  aah_for_rt_model_2bins <- aah_for_rt_model |> filter(handedness %in% c("Right", "Left"))
  rt_model_2bins <- lmer(
    rt ~ field:level:handedness
    + field:level
    + field:handedness
    + level:handedness
    + field + level + handedness
    + (1 | subject),
    data = aah_for_rt_model_2bins
    )
  
  ## Create emmeans model object, and manually cache it.
  rt_emm_2bins <- emmeans(rt_model_2bins, ~ field*level*handedness,
                          lmer.df = DF_METHOD,
                          lmerTest.limit = LMERTEST_LIMIT)
  rt_interaction_emm <- rt_emm_2bins |> 
  contrast(interaction = c("consec")) |>
  summary(infer = T)
  
  ## Manually cache model
  saveRDS(rt_model_2bins, here(manual_cache_dir, "rt_model_2bins.rds"))
  saveRDS(rt_emm_2bins, here(manual_cache_dir, "rt_emm_2bins.rds"))
  
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_model_2bins <- readRDS(here(manual_cache_dir, "rt_model_2bins.rds"))
  rt_emm_2bins <- readRDS(here(manual_cache_dir, "rt_emm_2bins.rds"))
}
```
<br>
```{r}
### FxLxH (Likelihood ratio test)
if (use_cached_models == FALSE) {
## Use anova() on competing models to test 3-way interaction.
rt_model_no_interaction <- update(rt_model_2bins, . ~ . - field:level:handedness)
interaction_anova <- interaction_stats(rt_model_2bins, rt_model_no_interaction)
  saveRDS(interaction_anova, here(manual_cache_dir, "rt_mm_cat_anova.rds"))
} else if (use_cached_models == TRUE) {
  interaction_anova <- readRDS(here(manual_cache_dir, "rt_mm_cat_anova.rds"))
}

interaction_anova |>
  as_tibble() |>
  rename(p.value = `Pr(>Chisq)`) |> 
  format_p.value() |> 
  pretty_table() |> 
  tab_header(title = str_glue("{experiment_label}: Field by Level by Handedness (RT)"), 
             subtitle = "ANOVA: compare models with vs. without interaction term") |> 
  tab_footnote(footnote = "F-test (two-sided? https://daniellakens.blogspot.com/2016/04/one-sided-f-tests-and-halving-p-values.html)",
               locations = cells_column_labels(columns = p.value))
```
<br>
```{r}
### FxLxH
## Use emmeans() to test 3-way interaction.
if (use_cached_models == FALSE) {
rt_interaction_emm <- rt_emm_2bins |> 
  contrast(interaction = c("consec")) |>
  summary(infer = T)
  saveRDS(rt_interaction_emm, here(manual_cache_dir, "rt_emm_2bins_FLH.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_interaction_emm <- readRDS(here(manual_cache_dir, "rt_emm_2bins_FLH.rds"))
}

rt_interaction_emm |>
  as_tibble() |>
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by Level by Handedness (RT)"),
             subtitle = "Compare effect estimate to zero with emmeans()") |>
  tab_footnote(footnote = "A positive number means LVF global bias is stronger in right handers (as predicted by AAH)",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Two-sided",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```

<br>
```{r}
#### FxL | H
## Estimate the effect of field by level for each handedness group
if (use_cached_models == FALSE) {
rt_emm2 <- emmeans(rt_model_2bins, ~field*level | handedness, lmer.df = DF_METHOD,
                          lmerTest.limit = LMERTEST_LIMIT) |>
  contrast(interaction = "consec") |>
  summary(infer = T, adj = "none")
  saveRDS(rt_emm2, here(manual_cache_dir, "rt_emm_2bins_FL_H.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emm2 <- readRDS(here(manual_cache_dir, "rt_emm_2bins_FL_H.rds"))
}

rt_emm2 |>
  as_tibble() |> 
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by Level (by Handedness) (RT)")) |> 
  tab_footnote(footnote = "A positive number means global bias (faster RT for global)",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>
```{r}
#### FxH | L
if (use_cached_models == FALSE) {
## Estimate the effect of field for each level for each handedness group
rt_emm_FH_L <- rt_emm_2bins |> contrast(interaction = "consec", by = c("level")) |> 
  summary(infer = T) 
  saveRDS(rt_emm_FH_L, here(manual_cache_dir, "rt_emm_2bins_FH_L.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emm_FH_L <- readRDS(here(manual_cache_dir, "rt_emm_2bins_FH_L.rds"))
}

rt_emm_FH_L |> 
  as_tibble() |> 
  format_p.value() |> 
  pretty_table() |> 
  tab_header(title = str_glue("{experiment_label}: Field by Handedess (by Level) (RT)")) |> 
  tab_footnote(footnote = "A positive number means more RVF bias for right handers",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))

```


```{r}
#### F | L | H
if (use_cached_models == FALSE) {
## Estimate the effect of field for each level for each handedness group
rt_emm2 <- emmeans(rt_model_2bins, ~field | handedness + level, lmer.df = DF_METHOD,
                          lmerTest.limit = LMERTEST_LIMIT) |>
  contrast("revpairwise", by = c("handedness","level")) |>
  summary(infer = T, adj = "none")
  saveRDS(rt_emm2, here(manual_cache_dir, "rt_emm_2bins_F_L_H.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emm2 <- readRDS(here(manual_cache_dir, "rt_emm_2bins_F_L_H.rds"))
}

rt_emm2 |>
  as_tibble() |> 
  format_p.value() |> 
  arrange(handedness, level) |> 
  pretty_table() |>
  tab_header(title = "LVF Global bias by handedness bin (RT)") |>
  tab_footnote(footnote = "A positive number means global bias (faster RT for global)",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```

### Plots

Diamonds and lineranges show mixed-effects model point estimates and 95% CI.

```{r plot_cat_model}
## Start over, with numeric y axis
## Add a line with CI from the model
fig_path_var <- here(fig_dir, "rt_1_lmer.png")

if (use_cached_figs == F) {
rt_emm <- readRDS(here(manual_cache_dir, "rt_emm_2bins.rds"))

## Get estimates for right and left handers.
rt_emm|>
  contrast("pairwise", by = c("handedness", "level")) |>
  summary(infer = T, level = .95)

emm_data_2 <- rt_emm |>
  contrast("pairwise", by = c("handedness", "level")) |>
  summary(infer = T, level = .95) |>
  as_tibble() |> 
  ## Fix units
  mutate(
    estimate = estimate * -1,
    lower.CL = lower.CL * -1,
    upper.CL = upper.CL * -1
  )


plot_data <- emm_data_2 |> mutate(dv = estimate)

## Extract n's (MANUALLY COUNT N IN DATAFRAME USED IN MODEL)
n_left <- rt_1 |> group_by(handedness) |> count() |> filter(handedness == "Left") |> pull(n)
n_right <- rt_1 |> group_by(handedness) |> count() |> filter(handedness == "Right") |> pull(n)

g <- gg_rt_2_lmer(
  title = "Hemifield bias by level (EHI cut at +/-40)",
  plot_data,
  handedness_labeller = NULL,
  plot_colors = plot_colors,
  direction_labels = list(right = "RVF bias",
                          left = "LVF bias"),
  direction_labels_pos = list(right = 38,
                              left = -38),
  xlims = list(upper = 38,
               lower = -38),
  xbreaks = list(major = 10,
                 minor = 5),
  n_subjects = list(
    right = n_right,
    left = n_left
  )
)

  ggsave(fig_path_var, g, "png", height = DEFAULT_HEIGHT, width = DEFAULT_WIDTH)
}

include_graphics(fig_path_var)
```
<br>


## Categorical handedness (exploratory - EHI +/-100) {.tabset .tabset-pills}

### Summary

Limiting analysis to strong left and right handers with EHI scores of +/-100, left handers' LVF>RVF global bias was reduced by 23.52ms (95\% CI [7.10, 39.93], $\chi^2(1)$ = 7.89, \textit{p} = .005, two-sided). Strong right handers showed significant LVF>RVF global bias (28.10ms, 95\% CI [17.34, 38.86], \textit{$t$}(38,617.45) = 5.12, \textit{p} < .0001, two-sided); whereas strong left handers showed no significant interaction of field by level (4.59ms, 95\% CI [-7.81, 16.98], \textit{t}(38,617.6) = 0.73, \textit{p} = .47, two-sided).

Within the local level, strong right and left handers showed reversed hemifield bias: right handers responded faster to local stimuli in the RVF than LVF by 13.56ms (95\% CI [5.90, 21.22],  \textit{$t$}(38,617.6) = 3.47, \textit{p} = .0005, two-sided), whereas left handers responded faster to local stimuli in the LVF than RVF by 18.09ms (95\% CI [9.25, 26.93], \textit{$t$}(38,617.69) = 4.01 \textit{p} < .0001, two-sided; difference = 31.65ms, 95\% CI [19.96, 43.35], \textit{$t$}(38,617.67) = 5.30, \textit{p} < .0001, two-sided).

### Stats

Reaction time is modeled as a linear effect of field, level, and handedness, using data from every target-present trial with a "go" response:
<br>
<br>
`lmer( rt ~ field*level*handedness + (1 | subject) )`
<br>
<br>
```{r rt_model_zoom}
#### FxLxH (prepare model)
## Make a model with two handedness bins: Right and Left
if (use_cached_models == FALSE) {
  aah_for_rt_model_zoom <- aah_for_rt_model |> filter(handedness_extremes %in% c("Right", "Left"))
  rt_model_zoom <- lmer(
    rt ~ field:level:handedness
    + field:level
    + field:handedness
    + level:handedness
    + field + level + handedness
    + (1 | subject),
    data = aah_for_rt_model_zoom
    )
  
  ## Create emmeans model object, and manually cache it.
  rt_emm_zoom <- emmeans(rt_model_zoom, ~ field*level*handedness,
                          lmer.df = DF_METHOD,
                          lmerTest.limit = LMERTEST_LIMIT)
  rt_interaction_emm <- rt_emm_zoom |> 
  contrast(interaction = c("consec")) |>
  summary(infer = T)
  
  ## Manually cache model
  saveRDS(rt_model_zoom, here(manual_cache_dir, "rt_model_zoom.rds"))
  saveRDS(rt_emm_zoom, here(manual_cache_dir, "rt_emm_zoom.rds"))
  
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_model_zoom <- readRDS(here(manual_cache_dir, "rt_model_zoom.rds"))
  rt_emm_zoom <- readRDS(here(manual_cache_dir, "rt_emm_zoom.rds"))
}
```
<br>
```{r}
### FxLxH (Likelihood ratio test)
if (use_cached_models == FALSE) {
## Use anova() on competing models to test 3-way interaction.
rt_model_no_interaction <- update(rt_model_zoom, . ~ . - field:level:handedness)
interaction_anova <- interaction_stats(rt_model_zoom, rt_model_no_interaction)
  saveRDS(interaction_anova, here(manual_cache_dir, "rt_mm_cat_anova_zoom.rds"))
} else if (use_cached_models == TRUE) {
  interaction_anova <- readRDS(here(manual_cache_dir, "rt_mm_cat_anova_zoom.rds"))
}

interaction_anova |>
  as_tibble() |>
  rename(p.value = `Pr(>Chisq)`) |> 
  format_p.value() |> 
  pretty_table() |> 
  tab_header(title = str_glue("{experiment_label}: Field by Level by Handedness (RT)"), 
             subtitle = "ANOVA: compare models with vs. without interaction term") |> 
  tab_footnote(footnote = "F-test (two-sided? https://daniellakens.blogspot.com/2016/04/one-sided-f-tests-and-halving-p-values.html)",
               locations = cells_column_labels(columns = p.value))
```
<br>
```{r rt_interaction_emm}
### FxLxH
if (use_cached_models == FALSE) {
rt_interaction_emm <- rt_emm_zoom |> 
  contrast(interaction = c("consec")) |>
  summary(infer = T)
  saveRDS(rt_interaction_emm, here(manual_cache_dir, "rt_emm_FLH_zoom.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_interaction_emm <- readRDS(here(manual_cache_dir, "rt_emm_FLH_zoom.rds"))
}

rt_interaction_emm |>
  as_tibble() |>
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by Level by Handedness (RT)"),
             subtitle = "Compare effect estimate to zero with emmeans()") |>
  tab_footnote(footnote = "A positive number means LVF global bias is stronger in right handers (as predicted by AAH)",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Two-sided",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```

<br>
```{r rt_handedness_bias}
#### FxL | H
## Estimate the effect of field by level for each handedness group
if (use_cached_models == FALSE) {
rt_emm2 <- emmeans(rt_model_zoom, ~field*level | handedness, lmer.df = DF_METHOD,
                          lmerTest.limit = LMERTEST_LIMIT) |>
  contrast(interaction = "consec") |>
  summary(infer = T, adj = "none")
  saveRDS(rt_emm2, here(manual_cache_dir, "rt_emm_zoom_FL_H.rds"))
  
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emm2 <- readRDS(here(manual_cache_dir, "rt_emm_zoom_FL_H.rds"))
}

rt_emm2 |>
  as_tibble() |> 
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by Level (by Handedness) (RT)")) |> 
  tab_footnote(footnote = "A positive number means global bias (faster RT for global)",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>
```{r}
#### FxH | L
if (use_cached_models == FALSE) {
rt_emm_FH_L <- rt_emm_zoom |> contrast(interaction = "consec", by = c("level")) |> 
  summary(infer = T)
  
  saveRDS(rt_emm_FH_L, here(manual_cache_dir, "rt_emm_FH_L_zoom.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emm_FH_L <- readRDS(here(manual_cache_dir, "rt_emm_FH_L_zoom.rds"))
}

rt_emm_FH_L |> 
  as_tibble() |> 
  format_p.value() |> 
  pretty_table() |> 
  tab_header(title = str_glue("{experiment_label}: Field by Handedess (by Level) (RT)")) |> 
  tab_footnote(footnote = "A positive number means more RVF bias for right handers",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))

```


```{r rt_handedness_bias_bylevel}
#### F | L | H
if (use_cached_models == FALSE) {
## Estimate the effect of field for each level for each handedness group
rt_emm2 <- emmeans(rt_model_zoom, ~field | handedness + level, lmer.df = DF_METHOD,
                          lmerTest.limit = LMERTEST_LIMIT) |>
  contrast("revpairwise", by = c("handedness","level")) |>
  summary(infer = T, adj = "none")
  saveRDS(rt_emm2, here(manual_cache_dir, "rt_emm_zoom_F_L_H.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emm2 <- readRDS(here(manual_cache_dir, "rt_emm_zoom_F_L_H.rds"))
}

rt_emm2 |>
  as_tibble() |> 
  format_p.value() |> 
  arrange(handedness, level) |> 
  pretty_table() |>
  tab_header(title = "LVF Global bias by handedness bin (RT)") |>
  tab_footnote(footnote = "A positive number means global bias (faster RT for global)",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```



### Plots

```{r plot_cat_model_zoom}
## Categorical plots: EHI extremes
## Start over, with numeric y axis
## Add a line with CI from the model
fig_path_var <- here(fig_dir, "rt_1_lmer_zoom.png")

if (use_cached_figs == F) {
## Get estimates for right and left handers.
zoom_data <- aah_for_rt_model |>
  filter(handedness_extremes %in% c("Right", "Left"))

emm_data_2 <- rt_emm_zoom |>
  contrast("pairwise", by = c("handedness", "level")) |>
  summary(infer = T, level = .95) |>
  as_tibble() |>
  ## Fix units
  mutate(
    estimate = estimate * -1,
    lower.CL = lower.CL * -1,
    upper.CL = upper.CL * -1
  )


plot_data <- emm_data_2 |> mutate(dv = estimate)

## Extract n's (MANUALLY COUNT N IN DATAFRAME USED IN MODEL)
n_tbl <- aah_for_rt_model |> group_by(subject) |>
  summarize(subject = first(subject), handedness_extremes = first(handedness_extremes)) |> group_by(handedness_extremes) |> count()
n_left <- n_tbl |> filter(handedness_extremes == "Left") |> pull(n)
n_right <- n_tbl |> filter(handedness_extremes == "Right") |> pull(n)

g <- gg_rt_2_lmer(
  title = "Hemifield bias by level (EHI +/-100)",
  plot_data,
  handedness_labeller = NULL,
  plot_colors = plot_colors,
  direction_labels = list(right = "RVF bias",
                          left = "LVF bias"),
  direction_labels_pos = list(right = 38,
                              left = -38),
  xlims = list(upper = 38,
               lower = -38),
  xbreaks = list(major = 10,
                 minor = 5),
  n_subjects = list(
    right = n_right,
    left = n_left
  )
)

  ggsave(fig_path_var, g, "png", height = DEFAULT_HEIGHT, width = DEFAULT_WIDTH)
}

include_graphics(fig_path_var)
```



## Categorical handedness (exploratory - shape) {.tabset .tabset-pills}

### Summary
Some pilot participants reported that the circle targets were relatively easy to see compared to the square targets, and indeed, reaction times were faster for circles than for squares, at both the local level (difference = 66.71ms, 95\% CI [62.81, 70.61], \textit{t}(85,494.1) = 14.49, \textit{p} < .0001, two-sided) and the global level (difference = 28.36ms, 95\% CI [24.53, 32.20], \textit{t}(85,491.0) = 14.49, \textit{p} < .0001, two-sided). Because global precedence effects may be stronger under perceptual uncertainty \parencite{navon_forest_1977}, the circles' high visibility could lead to lower global precedence, and potentially weaken the interaction of field by level. Indeed, participants showed greater global precedence for squares, by 40.68ms for right handers (95\% CI [33.21, 48.15], \textit{t}(85,492.1) = 10.67, \textit{p} < .0001, two-sided), and 36.01ms for left handers (95\% CI [28.01, 44.00], \textit{t}(85,492.9) = 8.83, \textit{p} < .001, two-sided). Within right handers, the interaction of field by level was greater for squares (37.66ms, 95\% CI [26.97, 48.34], \textit{t}(85,491.4) = 6.91, \textit{p} < .0001, two-sided) than for circles (18.14ms, 95\% CI [7.70, 28.58], \textit{t}(85,490.6) = 3.41, \textit{p} = .0007, two-sided; difference = 19.52ms, 95\% CI [4.58, 34.46], \textit{t}(85,490.9) = 2.56, \textit{p} = .01, two-sided).

Though target shape did not have a significant effect on the interaction of field by level by handedness (15.89ms greater for squares, 95\% CI [-5.99, 37.76], $\chi^2(1)$ = 2.03, \textit{p}= .16, two-sided), the interaction of field by level by handedness was significant for squares (19.76ms, 95\% CI [4.11, 35.40], \textit{t}(85,491.5) = 2.48, \textit{p} = .013, two-sided), but not for circles (3.87ms, 95\% CI [-11.41, 19.16], \textit{t}(85,490.62) = 0.50, \textit{p} = .62,two-sided). 

### Stats

Reaction time is modeled as a linear effect of field, level, handedness (EHI < -40 or EHI > +40), and shape, using data from every target-present trial with a "go" response:
<br>
<br>
`lmer( rt ~ field * level * handedness * shape + (1 | subject) )`
<br>
<br>

```{r FLSH_demo_2bins}
data_label <- "2bins"
data_sub <- aah_for_rt_model |> filter(handedness %in% c("Right", "Left")) |> rename(shape = target)
data_sub_summary <- aah_summary |> filter(handedness %in% c("Right", "Left"))
```

```{r FLSH_model_emm_2bins}
model_emm_FLSH <- function(manual_cache_dir,
                          data_label,
                          data,
                          use_cached_model = FALSE) {
  model_path <-
    here(manual_cache_dir, str_c("FLSH_model_", data_label, ".rds"))
  emm_path <-
    here(manual_cache_dir, str_c("FLSH_emm_", data_label, ".rds"))
  
  if (use_cached_model == FALSE) {
    ## Create model & emmeans object
    model <- lmer(rt ~ field * level * handedness * shape + (1 | subject),
                  data = data)
    emm <- emmeans(model, ~ field * level * handedness * shape,
                   lmer.df = DF_METHOD,
                   lmerTest.limit = LMERTEST_LIMIT)
    
    ## Manually cache model
    cli_progress_step(msg = "Caching model: {model_path}",
                      msg_done = "Created and cached model: {model_path}")
    saveRDS(model, model_path)
    cli_progress_step(msg = "Caching emm object: {emm_path}",
                      msg_done = "Created and cached emm_object: {emm_path}")
    saveRDS(emm, emm_path)
    
  } else if (use_cached_model == TRUE) {
    ## Load cached model & emmeans object
    cli_progress_step(msg = "Loading model: {model_path}",
                      msg_done = "Loaded model: {model_path}")
    model <- readRDS(model_path)
    cli_progress_step(msg = "Loading emm object: {emm_path}",
                      msg_done = "Loaded emm object: {emm_path}")
    emm <- readRDS(emm_path)
  }
  
  model_emm <- list()
  model_emm$model <- model
  model_emm$emm <- emm
  
  return(model_emm)
}

FLSH <- model_emm_FLSH(
  use_cached_model = use_cached_models,
  manual_cache_dir = manual_cache_dir,
  data = data_sub,
  data_label = data_label
)
```

```{r paper_FLSH}
## Test the 4-way interaction
emmtest_FLSH <- function(FLSH_emm, title = "") {
  FLSH_emmtest <- FLSH_emm |>
    contrast(interaction = c("consec")) |>
    summary(infer = T)
  
  FLSH_emmtest |>
    as_tibble() |>
    format_p.value() |>
    pretty_table() |>
    tab_header(title = title,
               subtitle = "Compare effect estimate to zero with emmeans()") |>
    tab_footnote(footnote = "A positive number means the interaction of field by level by handedness is stronger for squares",
                 locations = cells_column_labels(columns = estimate)) |>
    tab_footnote(footnote = "Two-sided",
                 locations = cells_column_labels(columns = p.value)) |>
    tab_footnote(footnote = "Confidence level: 95%",
                 locations = cells_column_labels(columns = ends_with("CL"))) |>
    tab_footnote(footnote = "Z-approximation",
                 locations = cells_column_labels(columns = df))
}

emmtest_FLSH(FLSH$emm, title = str_glue("{experiment_label}: Shape by Field by Level by Handedness (RT)"))
```

```{r}
## Test the 4-way interaction with anova
## ANOVA: is there a significant interaction of field by level by shape by handedness?
anova_FLSH <- function(use_cached_anova = FALSE,
                      manual_cache_dir,
                      FLSH_model,
                      data_label = data_label,
                      title = "") {
  anova_path <-
    here(manual_cache_dir, str_c("FLSH_anova_", data_label, ".rds"))
  
  if (use_cached_anova == FALSE) {
    FLSH_model_no_interaction <-
      update(FLSH_model, . ~ . - field:level:handedness:shape)
    interaction_anova <-
      interaction_stats(FLSH_model, FLSH_model_no_interaction)
    
    ## Cache anova
    cli_progress_step(msg = "Caching anova: {anova_path}",
                      msg_done = "Created and cached anova: {anova_path}")
    saveRDS(interaction_anova, anova_path)
    
  } else if (use_cached_anova == TRUE) {
    ## Load cached anova
    cli_progress_step(msg = "Loading anova: {anova_path}",
                      msg_done = "Loaded anova: {anova_path}")
    interaction_anova <- readRDS(anova_path)
  }
  
  cli_progress_step(msg = "Printing anova table: {anova_path}",
                    msg_done = "Printed anova table: {anova_path}")
  interaction_anova |>
    as_tibble() |>
    rename(p.value = `Pr(>Chisq)`) |>
    format_p.value() |>
    pretty_table() |>
    tab_header(title = title,
               subtitle = "ANOVA: compare models with vs. without interaction term") |>
    tab_footnote(footnote = "F-test (two-sided? https://daniellakens.blogspot.com/2016/04/one-sided-f-tests-and-halving-p-values.html)",
                 locations = cells_column_labels(columns = p.value))
}

anova_FLSH(use_cached_anova = use_cached_models,
          manual_cache_dir = manual_cache_dir,
          data_label = data_label,
          FLSH$model,
          title = str_glue("{experiment_label}: Shape by Field by Level by Handedness (RT)"))
```


```{r paper_FLS_H}
## Within each handedness group, what is the effect of shape on field by level?
emmtest_FLS_H <- function(use_cached_model = FALSE,
                         manual_cache_dir,
                         FLSH_model,
                         data_label,
                         title = "title") {
  emmtest_path <-
    here(manual_cache_dir,
         str_c("FLS_H_emmtest_", data_label, ".rds"))
  
  if (use_cached_model == FALSE) {
    FLS_H_emmtest <- FLSH_model |>
      emmeans(~ field * level * shape | handedness,
              lmer.df = DF_METHOD,
              lmerTest.limit = LMERTEST_LIMIT) |>
      contrast(interaction = c("consec")) |>
      summary(infer = T)
    
    ## Cache emm test object
    cli_progress_step(msg = "Caching emm test object: {emmtest_path}",
                      msg_done = "Created and cached anova: {emmtest_path}")
    saveRDS(FLS_H_emmtest, emmtest_path)
  } else if (use_cached_model == TRUE) {
    ## Load cached emm test
    cli_progress_step(msg = "Loading emm test object: {emmtest_path}",
                      msg_done = "Loaded emm test object: {emmtest_path}")
    FLS_H_emmtest <- readRDS(emmtest_path)
    
  }
  
  FLS_H_emmtest |>
    as_tibble() |>
    format_p.value() |>
    pretty_table() |>
    tab_header(title = title,
               subtitle = "Compare effect estimate to zero with emmeans()") |>
    tab_footnote(footnote = "A positive number means the interaction of field by level by handedness is stronger for squares",
                 locations = cells_column_labels(columns = estimate)) |>
    tab_footnote(footnote = "Two-sided",
                 locations = cells_column_labels(columns = p.value)) |>
    tab_footnote(footnote = "Confidence level: 95%",
                 locations = cells_column_labels(columns = ends_with("CL"))) |>
    tab_footnote(footnote = "Z-approximation",
                 locations = cells_column_labels(columns = df))
  
}

emmtest_FLS_H(use_cached_model = use_cached_models,
             manual_cache_dir = manual_cache_dir,
             FLSH$model,
             data_label = data_label,
             title = str_glue("{experiment_label}: Field by Level by Shape (by Handedness) (RT)"))
```


```{r paper_FL_H_S}
## Within each handedness group, what is the effect of field by level for each shape?
emmtest_FL_H_S <- function(use_cached_model = FALSE,
                         manual_cache_dir,
                         FLSH_model,
                         data_label,
                         title = "title") {
  emmtest_path <-
    here(manual_cache_dir,
         str_c("FL_H_S_emmtest_", data_label, ".rds"))
  
  if (use_cached_model == FALSE) {
    FL_H_S_emmtest <- FLSH_model |>
      emmeans(~ field * level | handedness | shape,
              lmer.df = DF_METHOD,
              lmerTest.limit = LMERTEST_LIMIT) |>
      contrast(interaction = c("consec")) |>
      summary(infer = T)
    
    ## Cache emm test object
    cli_progress_step(msg = "Caching emm test object: {emmtest_path}",
                      msg_done = "Created and cached anova: {emmtest_path}")
    saveRDS(FL_H_S_emmtest, emmtest_path)
  } else if (use_cached_model == TRUE) {
    ## Load cached emm test
    cli_progress_step(msg = "Loading emm test object: {emmtest_path}",
                      msg_done = "Loaded emm test object: {emmtest_path}")
    FL_H_S_emmtest <- readRDS(emmtest_path)
    
  }
  
  
  FL_H_S_emmtest |>
    as_tibble() |>
    format_p.value() |>
    pretty_table() |>
    tab_header(title = title,
               subtitle = "Compare effect estimate to zero with emmeans()") |>
    tab_footnote(footnote = "A positive number means LVF global bias",
                 locations = cells_column_labels(columns = estimate)) |>
    tab_footnote(footnote = "Two-sided",
                 locations = cells_column_labels(columns = p.value)) |>
    tab_footnote(footnote = "Confidence level: 95%",
                 locations = cells_column_labels(columns = ends_with("CL"))) |>
    tab_footnote(footnote = "Z-approximation",
                 locations = cells_column_labels(columns = df))
  
}

emmtest_FL_H_S(use_cached_model = use_cached_models,
               manual_cache_dir = manual_cache_dir,
               FLSH$emm,
               data_label = data_label,
               title = str_glue("{experiment_label}: Field by Level (by Handedness, by Shape) (RT)"))
```

```{r paper_LS_H}
## Estimate the effect of shape on level, by handedness group
emmtest_LS_H <- function(use_cached_model = FALSE,
                         manual_cache_dir,
                         FLSH_model,
                         data_label,
                         title = "title") {
  emmtest_path <-
    here(manual_cache_dir,
         str_c("LS_H_emmtest_", data_label, ".rds"))
  
  if (use_cached_model == FALSE) {
    LS_H_emmtest <- FLSH_model |>
      emmeans(~ level * shape | handedness) |>
      contrast(interaction = c("consec")) |>
      summary(infer = T)
    
    ## Cache emm test object
    cli_progress_step(msg = "Caching emm test object: {emmtest_path}",
                      msg_done = "Created and cached anova: {emmtest_path}")
    saveRDS(LS_H_emmtest, emmtest_path)
  } else if (use_cached_model == TRUE) {
    ## Load cached emm test
    cli_progress_step(msg = "Loading emm test object: {emmtest_path}",
                      msg_done = "Loaded emm test object: {emmtest_path}")
    LS_H_emmtest <- readRDS(emmtest_path)
    
  }
  
  LS_H_emmtest |>
    as_tibble() |>
    format_p.value() |>
    pretty_table() |>
    tab_header(title = title,
               subtitle = "Compare effect estimate to zero with emmeans()") |>
    tab_footnote(footnote = "A positive number means global bias is stronger for squares",
                 locations = cells_column_labels(columns = estimate)) |>
    tab_footnote(footnote = "Two-sided",
                 locations = cells_column_labels(columns = p.value)) |>
    tab_footnote(footnote = "Confidence level: 95%",
                 locations = cells_column_labels(columns = ends_with("CL"))) |>
    tab_footnote(footnote = "Z-approximation",
                 locations = cells_column_labels(columns = df))
  
}


emmtest_LS_H(use_cached_model = use_cached_models,
               manual_cache_dir = manual_cache_dir,
               FLSH$emm,
               data_label = data_label,
               title = str_glue("{experiment_label}: Shape by Level (by Handedness) (RT)"))
```

```{r paper_SL}
## In the full sample, is RT slower to squares, at each level?
## Estimate the effect of shape on level, by handedness group
emmtest_SL <- function(use_cached_model = FALSE,
                         manual_cache_dir,
                         FLSH_model,
                         data_label,
                         title = "title") {
  emmtest_path <-
    here(manual_cache_dir,
         str_c("SL_emmtest_", data_label, ".rds"))
  
  if (use_cached_model == FALSE) {
    SL_emmtest <- FLSH_model |>
      emmeans(~ shape | level) |>
      contrast(interaction = c("consec")) |>
      summary(infer = T)
    
    ## Cache emm test object
    cli_progress_step(msg = "Caching emm test object: {emmtest_path}",
                      msg_done = "Created and cached anova: {emmtest_path}")
    saveRDS(SL_emmtest, emmtest_path)
  } else if (use_cached_model == TRUE) {
    ## Load cached emm test
    cli_progress_step(msg = "Loading emm test object: {emmtest_path}",
                      msg_done = "Loaded emm test object: {emmtest_path}")
    SL_emmtest <- readRDS(emmtest_path)
    
  }
  
  SL_emmtest |>
    as_tibble() |>
    format_p.value() |>
    pretty_table() |>
    tab_header(title = title,
               subtitle = "Compare effect estimate to zero with emmeans()") |>
    tab_footnote(footnote = "A positive number means global bias is stronger for squares",
                 locations = cells_column_labels(columns = estimate)) |>
    tab_footnote(footnote = "Two-sided",
                 locations = cells_column_labels(columns = p.value)) |>
    tab_footnote(footnote = "Confidence level: 95%",
                 locations = cells_column_labels(columns = ends_with("CL"))) |>
    tab_footnote(footnote = "Z-approximation",
                 locations = cells_column_labels(columns = df))
  
}


emmtest_SL(use_cached_model = use_cached_models,
               manual_cache_dir = manual_cache_dir,
               FLSH$emm,
               data_label = data_label,
               title = str_glue("{experiment_label}: Shape (by Level) (RT)"))
```


```{r paper_FLH_S}
## What is the interaction of field by level by handedness, for each shape?
emmtest_FLH_S <- function(use_cached_model = FALSE,
                         manual_cache_dir,
                         FLSH_model,
                         data_label,
                         title = "title") {
  emmtest_path <-
    here(manual_cache_dir,
         str_c("FLH_S_emmtest_", data_label, ".rds"))
  
  if (use_cached_model == FALSE) {
    FLH_S_emmtest <- FLSH_model |>
      emmeans(~ field * level * handedness | shape,
              lmer.df = DF_METHOD,
              lmerTest.limit = LMERTEST_LIMIT) |>
      contrast(interaction = c("consec")) |>
      summary(infer = T)
    
    ## Cache emm test object
    cli_progress_step(msg = "Caching emm test object: {emmtest_path}",
                      msg_done = "Created and cached anova: {emmtest_path}")
    saveRDS(FLH_S_emmtest, emmtest_path)
  } else if (use_cached_model == TRUE) {
    ## Load cached emm test
    cli_progress_step(msg = "Loading emm test object: {emmtest_path}",
                      msg_done = "Loaded emm test object: {emmtest_path}")
    FLH_S_emmtest <- readRDS(emmtest_path)
    
  }
  
  FLH_S_emmtest |>
    as_tibble() |>
    format_p.value() |>
    pretty_table() |>
    tab_header(title = title,
               subtitle = "Compare effect estimate to zero with emmeans()") |>
    tab_footnote(footnote = "A positive number means more LVF global bias for right handers",
                 locations = cells_column_labels(columns = estimate)) |>
    tab_footnote(footnote = "Two-sided",
                 locations = cells_column_labels(columns = p.value)) |>
    tab_footnote(footnote = "Confidence level: 95%",
                 locations = cells_column_labels(columns = ends_with("CL"))) |>
    tab_footnote(footnote = "Z-approximation",
                 locations = cells_column_labels(columns = df))
  
}

emmtest_FLH_S(use_cached_model = use_cached_models,
             manual_cache_dir = manual_cache_dir,
             FLSH$model,
             data_label = data_label,
             title = str_glue("{experiment_label}: Field by Level by Handedness (by Shape) (RT)"))
```

## Continuous handedness (primary) {.tabset .tabset-pills}

### Summary

With handedness treated as continuous, left handedness predicted reduced LVF global>local bias (0.067ms per EHI unit, 95\% CI [0.003, 0.130], $\chi^2(1)$ = 4.25, \textit{p} = .039, two-sided). Estimated LVF global>local bias for EHI +100 (strong right handers) was 28.14ms (95\% CI [20.31, 35.98]), and for EHI -100 (strong left handers), 14.82ms (95\% CI [6.48, 23.17]), a difference of 13.32ms.

Within the local level, left handedness predicted reversed RVF bias (0.123ms per EHI unit, 95\% CI [0.078, 0.168], \textit{$t$}(101,766.6) = 5.34, \textit{p} = < .0001, two-sided). Strong right handers (EHI = +100) showed estimated RVF bias of 14.96ms (95\% CI [9.38, 20.53]), and strong left handers (EHI = -100) showed estimated LVF bias of 9.61ms (95\% CI [-1.88, 8.43]), a difference of 24.57ms.

### Stats

```{r}
rt_ehi_1 <- rt_1 |>
  left_join(aah_summary |> select(subject, ehi)) |>
  select(subject, ehi, LVF_Global_Bias)
```

Model RT as a linear effect of field, level, and EHI (continuous):
<br>
<br>
`rt_model_ehi <- lmer( rt ~ field*level*ehi + (1 | subject) )`
<br>
<br>
```{r rt_model_ehil}
## Prepare data, so emmeans contrasts show
## Global bias as a positive number.
aah_for_rt_ehi_model <- aah_for_rt_model |>
  mutate(level = level |> factor(levels = c("Local", "Global")),
         field = field |> factor(levels = c("LVF", "RVF")))
```


```{r rt_model_ehi_caching}
if (use_cached_models == FALSE) {
  rt_model_ehi <- lmer(rt ~ field:level:ehi + field:level + field:ehi + level:ehi + field + level + ehi + (1 | subject), data = aah_for_rt_ehi_model)
  
  ## Create emmeans model object, and manually cache it.
  rt_emm_ehi <- emmeans(rt_model_ehi, ~ field * level * ehi,
                        lmer.df = DF_METHOD,
                        lmerTest.limit = LMERTEST_LIMIT)
  
  ## Manually cache model
  saveRDS(rt_model_ehi, here(manual_cache_dir, "rt_model_ehi.rds"))
  saveRDS(rt_emm_ehi, here(manual_cache_dir, "rt_emm_ehi.rds"))
  
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_model_ehi <- readRDS(here(manual_cache_dir, "rt_model_ehi.rds"))
  rt_emm_ehi <- readRDS(here(manual_cache_dir, "rt_emm_ehi.rds"))
}
```

```{r rt_ehi_interaction_anova, echo = F}
## Use anova() on competing models to test 3-way interaction.
if (use_cached_models == FALSE) {
rt_model_no_interaction <- update(rt_model_ehi, . ~ . - field:level:ehi)
interaction_anova <- interaction_stats(rt_model_ehi, rt_model_no_interaction)

  saveRDS(interaction_anova, here(manual_cache_dir, "rt_mm_cont_anova.rds"))
} else if (use_cached_models == TRUE) {
  interaction_anova <- readRDS(here(manual_cache_dir, "rt_mm_cont_anova.rds"))
}
interaction_anova |>
  as_tibble() |>
  rename(p.value = `Pr(>Chisq)`) |> 
  format_p.value() |> 
  pretty_table() |> 
  tab_header(title = str_glue("{experiment_label}: Field by Level by EHI (RT)"), 
             subtitle = "ANOVA: compare models with vs. without interaction term") |> 
  tab_footnote(footnote = "F-test (two-sided? https://daniellakens.blogspot.com/2016/04/one-sided-f-tests-and-halving-p-values.html)",
               locations = cells_column_labels(columns = p.value))
```
<br>
```{r}
## Test whether interaction slope differs from zero, with emmeans

## This code estimates the effect of EHI on RT for each field*level:
rt_emt <- emtrends(rt_model_ehi, pairwise ~ field*level, var = "ehi", lmer.df = DF_METHOD,
                        lmerTest.limit = LMERTEST_LIMIT)
## We want to compare the effect of EHI on RT for:
## (LVF Local - LVF Global) - (RVF local - RVF Global)
## Contrast indices: 2 - 5

## Report interaction estimate, with CI and p value.
rt_emt[[1]] |> contrast(interaction = c("consec"), var = "ehi") |> 
  summary(infer = T) |>
  format_p.value() |> 
  pretty_table() |> 
  tab_header(title = str_glue("{experiment_label}: Field by Level by EHI (RT)"), 
             subtitle = "Compare effect estimate to zero with emmeans()") |>
  tab_footnote(footnote = "A positive number means global bias is stronger in LVF for right handers (as predicted by AAH), in ms per EHI unit (-100 to 100). Multiply this value by 200 to get the estimated difference in LVF global bias for strong left vs. right handers.",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Two-sided",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Confidence level: 95",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>
```{r}
## Report estimated effect of field, for each level, by ehi.
## Test whether interaction slope differs from zero, with emmeans

## This code estimates the effect of EHI on RT for each field*level:
rt_emt <- emtrends(rt_model_ehi, pairwise ~ field*level, var = "ehi",
                   lmer.df = DF_METHOD, lmerTest.limit = LMERTEST_LIMIT)
## We want to compare the effect of EHI on RT for:
## (LVF Local - LVF Global) - (RVF local - RVF Global)
## Contrast indices: 2 - 5

## Report interaction estimate, with CI and p value.
rt_emt[[1]] |> contrast("pairwise", by = "level", var = "ehi") |> 
  summary(infer = T) |>
  format_p.value() |> 
  pretty_table() |> 
  tab_header(title = str_glue("{experiment_label}: Field by EHI (by Level) (RT)"), 
             subtitle = "Compare effect estimate to zero with emmeans()") |>
  tab_footnote(footnote = "A positive number means global bias is stronger in LVF for right handers (as predicted by AAH), in ms per EHI unit (-100 to 100). Multiply this value by 200 to get the estimated difference in LVF global bias for strong left vs. right handers.",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = "Two-sided",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Confidence level: 95",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>

```{r}
## LVF Global bias by EHI.
## Pull estimates for strong left and right handers (ehi = -100, +100)
## Estimate effect of ehi on field x level.

## Use ref_grid (following quant 2 HW5)
ref <- ref_grid(rt_model_ehi, at = list(ehi = c(-100, 0, 100)),
                   lmer.df = DF_METHOD, lmerTest.limit = LMERTEST_LIMIT)

## Show estimates for left and right handers.
ref |>
  contrast(interaction = c("consec"), by = "ehi") |>
  summary(infer = T, type = "response") |>
  as_tibble() |>
  format_p.value() |>
  pretty_table() |>
  tab_header(title = "Estimated Field by Level interaction, by EHI score") |>
  tab_footnote(footnote = "Strong left hander: -100; Mixed hander: 0; Strong right hander: +100",
               locations = cells_column_labels(columns = ehi)) |>
  tab_footnote(footnote = "Estimated LVF global bias (ms); a positive number means LVF global bias",
               locations = cells_column_labels(columns = estimate))
```
<br>
```{r}
## Global bias by field, by handedness.
ref |>
  contrast("pairwise", by = c("level", "ehi")) |>
  summary(infer = T, type = "response") |>
  as_tibble() |>
  # filter(contrast %in% c("LVF Local - RVF Local", "LVF Global - RVF Global")) |>
  format_p.value() |>
  arrange(ehi) |>
  pretty_table() |>
  tab_header(title = "Estimated global bias by field, by EHI score") |>
  tab_footnote(footnote = "Estimated global bias (ms); a positive number means global bias",
               locations = cells_column_labels(columns = estimate))
```

### Plots
```{r plot_rt_cor_bins_config}
# plot_color = plot_blue
middle_purple1 <- "#996F91" ## In between plot colors one and two
middle_purple2 <- "#886e92" ## In between plot colors one and two
plot_color <- middle_purple1

h_plot_colors <- c(plot_colors[[1]], middle_purple1, plot_colors[[2]])
```

```{r}
## Plot correlation for local and global shapes (facets)
## Add a line with CI from the model
fig_path_var <- here(fig_dir, "rt_2_cor_bins_line.png")
fig_path_var_wide <- here(fig_dir, "rt_2_cor_bins_line.png")


if (use_cached_figs == F) {
## Extract line of best fit, confidence bounds from model.
rt_model_ehi <- readRDS(here(manual_cache_dir, "rt_model_ehi.rds"))


line_data <- rt_model_ehi |> 
  ref_grid(at = list(ehi = seq(-100, 100, 12.5)),
           lmer.df = DF_METHOD,
                        lmerTest.limit = LMERTEST_LIMIT
           ) |> 
  emmeans(~ field * ehi, by = "level") |> 
  contrast(interaction = c("consec"), by = c("ehi", "level"), level = .95) |> 
  summary(infer = T) |> 
  as_tibble()

# ref <- ref_grid(rt_model_ehi, at = list(ehi = seq(-100, 100, 12.5)))
# line_data <- ref |> contrast(interaction = c("consec"), by = "ehi", level = .95) |>
#   summary(infer = T) |>
#   as_tibble()

rt_subject_plot <- rt_subject |>
  pivot_wider(names_from = c(field, level),
              values_from = rt) |>
  mutate(LVF_Global_Bias = (RVF_Global - RVF_Local) - (LVF_Global - LVF_Local)) |>
  left_join(aah_summary, by = c("subject", "handedness")) |>
  select(subject, ehi, starts_with("LVF"), handedness, handedness_extremes) |>
  ## Set "dv" here to make it easy to write a reusable function
  mutate(dv = LVF_Global_Bias) |>
  ungroup()

rt_subject_plot <- rt_subject |>
  pivot_wider(names_from = c(field),
              values_from = rt) |>
   mutate(LVF_Bias = RVF - LVF) |> 
  left_join(aah_summary, by = c("subject", "handedness")) |>
  select(subject, level, ehi, starts_with("LVF"), handedness, handedness_extremes) |> 
  ## Set "dv" here to make it easy to write a reusable function
  mutate(dv = LVF_Bias) |> 
  ungroup()

  g <-
    gg_rt_2_line(
      title = "Frequency specialization by handedness (continuous)",
      y_title = "RVF - LVF reaction time (ms)",
      rt_subject_plot = rt_subject_plot,
      plot_colors = h_plot_colors,
      plot_color = plot_color,
      group_by_level = T,
      direction_labels = list(
        up = "LVF Bias",
        down = "RVF Bias"),
      direction_labels_pos = list(
        up = 48,
        down = -68),
      ylims = list(
        upper = 50,
        lower = -70),
      ybreaks = list(
        major = 10,
        minor = 5)
    ) |>
    gg_style_cor_bin()
  
  g <- g +
  geom_line(data = line_data,
            aes(y = estimate)) +
    geom_ribbon(data = line_data,
                inherit.aes = F,
              aes(x = ehi, ymin = lower.CL, ymax = upper.CL),
              fill = plot_color,
              alpha = .2)
  
  g <- g + facet_wrap(~ level, nrow = 1)
  ggsave(fig_path_var, g, "png", height = 4, width = 4)
  ggsave(fig_path_var_wide, g, "png", height = 4, width = 8)
}

include_graphics(fig_path_var)
```
<br>