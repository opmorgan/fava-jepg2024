---
title: "Experiments 1 & 2: Reaction Time Analyses"
pagetitle: "exp 1-2 | RT analyses"
author: "Owen Morgan"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

<style type="text/css">
  body{
  font-family: Avenir;
  font-size: 12pt;
}
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.align = "center", fig.width = 9,
                      fig.height = 6, results = "markup")
options(knitr.kable.NA = "")

cli.progress_show_after <- 0

## Do not use scientific notation until 9 decimal places.
options(scipen = 9, digits = 9)

# Suppress summarise info
options(dplyr.summarise.inform = FALSE)
```

```{r lib}
library(here)
library(tidyverse)
select <- dplyr::select
library(cli) # For printing error messages
library(glue)

library(lme4)
library(emmeans)
library(broom)
library(gt)

library(ggpubr) ## functions for plotting SD, SEM, CI.
library(ggbeeswarm)
library(patchwork)
library(ggh4x) ## for nested facets

library(knitr) # For include_graphics

source(here::here("lib", "util.R"))
source(here::here("lib", "demographics.R"))
source(here::here("lib", "plots-jepg.R"))

EXPERIMENT_DIR <- "experiments_1-2"
source(here::here(EXPERIMENT_DIR, "lib", "load_process", "load_process.R"))
source(here::here(EXPERIMENT_DIR, "lib", "tests.R"))

interaction_stats <-
  function(model_with_interaction,
           model_with_no_interaction) {
    return(anova(model_with_interaction, model_with_no_interaction))
  }

plot_blue <- c("#337aB7")
plot_colors <- c("#4477AA",
                 "#EE6677",
                 "#CCBB44",
                 "#66CCEE",
                 "#AA3377",
                 "#228833",
                 "#BBBBBB")
```

```{r config}
experiment_label <- "Experiments 1 and 2"

## Emmeans settings (use Satterthwaire approx. instead of default t-to-z for large df)
## See: Luke (2017). Evaluating significance in linear mixed-effects models in R
DF_METHOD <- "satterthwaite"
LMERTEST_LIMIT <- 500000

## Figure settings
DEFAULT_HEIGHT = 3
DEFAULT_WIDTH = 5

## Specify directories
proc_dir_e1 <- set_or_make_dir(label = "proc (e1)",
  here::here(EXPERIMENT_DIR, "data", "proc_exp_n1008")
)
proc_dir_e2 <- set_or_make_dir(label = "proc (e2)",
  here::here(EXPERIMENT_DIR, "data", "proc_exp_n1450")
)
fig_dir <- set_or_make_dir(label = "fig",
  here::here(EXPERIMENT_DIR, "figures")
)
manual_cache_dir <- set_or_make_dir(label = "manual cache",
 here::here(EXPERIMENT_DIR, "manual_cache")
)

use_cached_figs <- F
use_cached_models <- F
use_cached_proc_data <- F
```

# {.tabset}
```{r load_data}
## Load "the data" with all subjects & AAH trials.
aah_long_e1 <- load_aah_long(proc_dir_e1) |> mutate(experiment = "one")
aah_long_e2 <- load_aah_long(proc_dir_e2) |> mutate(experiment = "two")
test_for_dupes(aah_long_e1, aah_long_e2)
aah_long <- bind_rows(aah_long_e1, aah_long_e2)

## Load summary data table
## with all subjects.
aah_summary_all_e1 <- read_tsv(here(proc_dir_e1, "aah_summary.tsv")) |> 
  mutate(experiment = "one")
aah_summary_all_e2 <- read_tsv(here(proc_dir_e2, "aah_summary.tsv")) |> 
  mutate(experiment = "two")
test_for_dupes(aah_summary_all_e1, aah_summary_all_e2)
aah_summary_all <- bind_rows(aah_summary_all_e1, aah_summary_all_e2)
```

```{r prepare_data}
# use_cached_proc_data <- FALSE
#### PREPARE SUMMARY DATA FOR DEMOGRAPHICS ANALYSES (NAVON EXCLUSIONS)
if (use_cached_proc_data == FALSE) {
  cli::cli_alert_info("Filtering summary data for analysis (no excluded subjects).")
  cli::cli_bullets(c(" " = "aah_summary_all -> aah_summary"))
  aah_summary <- aah_summary_all |>
    filter(
      (experiment == "two" & exclude_navon == 0) |
      (experiment == "one" & exclude == 0)
      ) |>
    select(-starts_with("exclude")) |>
    mutate(
      handedness_extremes = case_when(ehi == -100 ~ "Left",
                                      ehi == 100 ~ "Right",
                                      ehi > -100 &
                                        ehi < 100 ~ "Mixed")
    )
  saveRDS(aah_summary, here(manual_cache_dir, "aah_summary.rds"))
} else {
  aah_summary <- readRDS(here(manual_cache_dir, "aah_summary.rds"))
}

#### PREPARE TRIAL-LEVEL DATA FOR RT, ACCURACY ANALYSES
## Prepare "the data" (aah_long) for all analyses:
## Filter out practice trials, absent trials, and excluded subjects
## This data (all present trials, correct or incorrect) will be used for
## accuracy analyses
if (use_cached_proc_data == FALSE) {
cli::cli_alert_info("Filtering long navon data for analysis (no excluded subjects; experimental trials (not practice) only; target present only).")
aah <- aah_long |>
    filter(
      (experiment == "two" & exclude_navon == 0) |
      (experiment == "one" & exclude == 0)
      ) |>
  filter(block_type == "main" & target_present == "yes") |>
  select(-starts_with("exclude")) |>
  ## Recode "level", "target" for nicer printing.
  mutate(level = recode(level, global = "Global", local = "Local")) |>
  mutate(target = recode(target, square = "Square", rectangle = "Rectangle",
                         circle = "Circle")) |>
  rename(shape = target) |> 
  ## Code handedness extremes
  mutate(
    handedness_extremes = case_when(ehi == -100 ~ "Left",
                                    ehi == 100 ~ "Right",
                                    ehi > -100 & ehi < 100 ~ "Mixed")
    )
  saveRDS(aah, here(manual_cache_dir, "aah.rds"))
} else {
  aah <- readRDS(here(manual_cache_dir, "aah.rds"))
}

## For RT analyses, prepare dataset with only correct, present trials.
## In our RT model, we only care about correct responses to present trials.
if (use_cached_proc_data == FALSE) {
aah_correct <- aah |> filter(correct == T)
  saveRDS(aah_correct, here(manual_cache_dir, "aah_correct.rds"))
} else {
  aah_correct <- readRDS(here(manual_cache_dir, "aah_correct.rds"))
}

## Relevel field and level with RVF first (unintuitive for plotting),
## so that emmeans will show a positive number for LVF global bias.
if (use_cached_proc_data == FALSE) {
aah_for_rt_model <- aah_correct |>
  mutate(level = level |> factor(levels = c("Global", "Local")),
         field = field |> factor(levels = c("RVF", "LVF")))
  saveRDS(aah_for_rt_model, here(manual_cache_dir, "aah_for_rt_model.rds"))
} else {
  aah_for_rt_model <- readRDS(here(manual_cache_dir, "aah_for_rt_model.rds"))
}

## For accuracy analyses, prepare dataset will all present trials.
## Relevel field and level,
## so that emmeans will show a positive number for LVF global bias.
if (use_cached_proc_data == FALSE) {
aah_for_acc_model <- aah |>
  mutate(level = level |> factor(levels = c("Global", "Local")),
         field = field |> factor(levels = c("RVF", "LVF")))
  saveRDS(aah_for_acc_model, here(manual_cache_dir, "aah_for_acc_model.rds"))
} else {
  aah_for_acc_model <- readRDS(here(manual_cache_dir, "aah_for_acc_model.rds"))
}

#### PREPARE SUBJECT_LEVEL DATA FOR RT, ACCURACY ANALYSES
## Prepare subject-level data (RT)
if (use_cached_proc_data == FALSE) {
rt_subject <- aah_correct |> group_by(subject, field, level, handedness, experiment) |>
  summarize(rt = median(rt))
  saveRDS(rt_subject, here(manual_cache_dir, "rt_subject.rds"))
} else {
  rt_subject <- readRDS(here(manual_cache_dir, "rt_subject.rds"))
}


## Prepare subject-level LVF Global bias summary (RT)
if (use_cached_proc_data == FALSE) {
rt_1 <- rt_subject |>
  pivot_wider(names_from = c(field, level),
              values_from = rt) |>
  mutate(LVF_Global_Bias = (RVF_Global - RVF_Local) - (LVF_Global - LVF_Local)) |>
  mutate(all_one_group = "all_one_group")
  saveRDS(rt_1, here(manual_cache_dir, "rt_1.rds"))
} else {
  rt_1 <- readRDS(here(manual_cache_dir, "rt_1.rds"))
}
```

## Summary

*All p-values two-sided.*

1,958 combined participants (860 left handers, 307 mixed handers, and 791 right handers) met inclusion criteria for experiments 1 or 2 (E1: n = 844 [331, 135, 378]; E2: n = 1,114 [529, 172, 413]). 

### Categorical handedness

#### Primary: EHI +/-40
Combining experiments, LVF global>local bias was significantly reduced in left handers (\textit{n} = 860, EHI <= -40) compared to right handers (\textit{n} = 791, EHI >= +40; difference between groups = 16.01ms, 95\% CI [8.58, 23.51], \textit{t}(196,641.1) = 4.21, \textit{p} < .0001, two-sided) . Right handers showed 35.84ms LVF global>local bias (95\% CI [30.51, 41.16], \textit{t}(196,641.2) = 13.19, \textit{p} < .0001, two-sided), and left handers showed only 19.79ms LVF global>local bias (95\% CI [14.55, 25.03], \textit{t}(196,641.0) = 7.41, \textit{p} < .0001, two-sided). The interaction of field by level by handedness did not differ significantly between experiments (difference = 9.0ms greater in Experiment 2, 95\% CI [-5.92, 23.96], \textit{t}(196,642.0) = 1.18, \textit{p} = .24). 

Within the local level, left handers showed reversed hemifield bias, in the direction predicted by AAH: right handers responded faster to local targets in the RVF than LVF by 15.46ms (95\% CI [11.55, 19.17], \textit{t}(196,642.6) = 7.91, \textit{p} < .0001), whereas left handers responded faster to local targets in the LVF than RVF by 5.00ms (95\%CI [1.26, 8.74], \textit{t}(196,642.4) = 2.62, p = .009, two-sided; difference = 16.05, 95\% CI [8.58, 23.51], \textit{t}(196,641.1) = 4.21, \textit{p} < .0001, two-sided). The effect of handedness on local hemifield bias did not differ significantly between experiments (difference = 3.20ms greater in Experiment 1, 95\% CI [-7.47, 13.88], \textit{t}(196,642.5) = 0.59, \textit{p} = .56, two-sided.

#### Exploratory: EHI +/-100
Limiting analysis to strong left and right handers with EHI scores of {$\pm$}100, left handers' LVF>RVF global bias was reduced by 20.49ms (95\% CI [9.05, 31.93], \textit{t}(83,094.7) = 3.51, \textit{p} = .0005, two-sided). Both groups showed significant LVF global>local bias: for right handers, the effect size was 32.68ms (95\% CI [24.78 ,40.57], \textit{$t$}(83,095.0) = 8.11, \textit{p} < .0001, two-sided); for left handers, only 12.19ms (95\% CI [3.90, 20.47], \textit{$t$}(83,094.4) = 2.88, \textit{p} = .004, two-sided). The interaction of field by level by handedness did not differ significantly between experiments (difference = 6.03ms greater in Experiment 1, 95\% CI [-16.86, 28.92], \textit{t}(83,094.7) = 0.52, \textit{p} = .61). 

Within the local level, left handers showed reversed hemifield bias: right handers responded faster to local targets in the RVF than LVF by 11.86ms (95\% CI [6.21, 17.51],  \textit{$t$}(83,095.4) = 4.11, \textit{p} < .0001, two-sided), whereas left handers responded faster to local targets in the LVF than RVF by 12.99ms (95\% CI [7.06, 18.91], \textit{$t$}(83,094.9) = 4.30 \textit{p} < .0001, two-sided; difference = 24.85ms, 95\% CI [16.66, 33.04], \textit{$t$}(83,095.2) = 5.95, \textit{p} < .0001, two-sided). The effect of handedness on local hemifield bias did not differ significantly between experiments (difference = 13.78ms greater in Experiment 1, 95\% CI [-2.61, 30.16], \textit{t}(83,095.1) = 1.65, \textit{p} = .10, two-sided).

### Continuous handedness
Combining experiments, left handedness predicted reduced LVF global>local bias (0.097ms per EHI unit, 95\% CI [0.054, 0.141], \textit{t}(233,104.7) = 4.39, \textit{p} < .0001, two-sided). Strong right handers (EHI = +100) showed estimated LVF global>local bias of 37.03ms (95\% CI [31.47, 42.58], \textit{t}(233,104.9) = 13.06, \textit{p} < .0001, two-sided), and strong left handers (EHI = -100) showed estimated LVF global>local bias of 17.54ms (95\% CI [12.02, 23.07], \textit{t}(233,104.5) = 6.22, \textit{p} < .0001, two-sided). The interaction of field by level by handedness did not differ significantly between experiments (difference = 0.063ms per EHI unit, 95\% CI [-0.024, 0.15], $\chi^2(1)$ = 1.99, \textit{p} = .16, two-sided).

Within the local level, left handedness predicted reversed hemifield bias (0.123ms per EHI unit, 95\% CI [0.092, 0.154], \textit{t}(233,106.3) = 7.76, \textit{p} < .0001, two-sided). Strong right handers (EHI +100) showed estimated RVF local bias of 18.31 (95\% CI [14.34, 22.28], \textit{t}(233,106.6) = 9.03, \textit{p} < .0001, two-sided), whereas strong left handers (EHI -100) showed estimated LVF local bias of 6.33ms (95\% CI [2.38, 10.28], \textit{t}(233,106.1) = 3.14, \textit{p} = .002, two-sided). The effect of handedness on local hemifield bias did not differ between experiments (difference = 0.00ms per EHI unit, 95\% CI [-0.063, 0.062], \textit{t} (233,106.2) = 0.01, p = .99, two-sided).


## Demographics {.tabset .tabset-pills}

### Summary
```{r}
demo_table <- aah_summary |>
  summarize(
            N = n(),
            `Age (years)` = report_mean_sd(age),
            `Education (years)` = report_mean_sd(education),
            `Sex (M/F/O)` = report_sex(sex)
  )

demo_table |>
  pretty_table() |> 
  tab_header(title = "Demographics, combining experiments", subtitle = "Summary")
```
<br>
```{r}
## Pool experiments, break up by handedness
demo_table <- aah_summary |>
  group_by(handedness) |> 
  summarize(
            N = n(),
            `Age (years)` = report_mean_sd(age),
            `Education (years)` = report_mean_sd(education),
            `Sex (M/F/O)` = report_sex(sex),
            EHI = report_mean_sd(ehi)
  ) |> 
  rename(Handedness = handedness)

demo_table |>
  pretty_table(groupname_col = "experiment") |> 
  tab_header(title = "Demographics, combining experiments", subtitle = "Summary") |> 
  tab_footnote("Left: (EHI <= -40)  |  Mixed: (-40 < EHI < 40)  |  Right: (EHI >= 40)")
```
<br>
```{r}
demo_table <- aah_summary |>
  mutate(experiment = paste0("Experiment ", experiment)) |> 
  group_by(experiment) |> 
  summarize(
            N = n(),
            `Age (years)` = report_mean_sd(age),
            `Education (years)` = report_mean_sd(education),
            `Sex (M/F/O)` = report_sex(sex)
  )

demo_table |>
  pretty_table() |> 
  tab_header(title = "Demographics by experiment", subtitle = "Summary")
```
<br>
```{r}
demo_table <- aah_summary |>
  mutate(experiment = paste0("Experiment ", experiment)) |> 
  group_by(experiment, handedness) |> 
  summarize(
            N = n(),
            `Age (years)` = report_mean_sd(age),
            `Education (years)` = report_mean_sd(education),
            `Sex (M/F/O)` = report_sex(sex),
            EHI = report_mean_sd(ehi)
  ) |> 
  rename(Handedness = handedness)

demo_table |>
  pretty_table(groupname_col = "experiment") |> 
  tab_header(title = "Demographics by experiment", subtitle = "Summary") |> 
  tab_footnote("Left: (EHI <= -40)  |  Mixed: (-40 < EHI < 40)  |  Right: (EHI >= 40)")
```
<br>


### Race

```{r}
group_n <- aah_summary |> 
  summarize(n_group = n()) |> pull(n_group)
demo_race <- aah_summary |> 
  group_by(race) |>
  summarize(n = n(),
            pct = round((n/group_n*100), 1)
            ) |>
  arrange(-n) |> 
  rename(Race = race)

demo_race |>
  pretty_table() |> 
  tab_header(title = "Demographics, combining experiments", subtitle = "Race")
```
<br>
```{r}
demo_ethnicity <- aah_summary |>
  group_by(hispanic_ethnicity) |>
  summarize(n = n(),
            pct = round((n/group_n)*100, 1)
            ) |>
  arrange(-n) |> 
  rename(`Hispanic ethnicity` = hispanic_ethnicity)

demo_ethnicity |>
  pretty_table() |> 
  tab_header(title = "Demographics, combining experiments", subtitle = "Ethnicity")
```
<br>
```{r}
group_ns <- aah_summary |> group_by(experiment) |> 
  summarize(n_group = n())
demo_race <- aah_summary |> full_join(group_ns) |> 
  mutate(experiment = paste0("Experiment ", experiment)) |> 
  group_by(experiment, race) |>
  summarize(n = n(),
            pct = round((n/first(n_group))*100, 1)
            ) |>
  arrange(experiment, -n) |> 
  rename(Race = race)

demo_race |>
  pretty_table(groupname_col = "experiment") |> 
  tab_header(title = "Demographics by experiment", subtitle = "Race")
```
<br>
```{r}
demo_ethnicity <- aah_summary |> full_join(group_ns) |> 
  mutate(experiment = paste0("Experiment ", experiment)) |> 
  group_by(experiment, hispanic_ethnicity) |>
  summarize(n = n(),
            pct = round((n/first(n_group))*100, 1)
            ) |>
  arrange(experiment, -n) |> 
  rename(`Hispanic ethnicity` = hispanic_ethnicity)

demo_ethnicity |>
  pretty_table(groupname_col = "experiment") |> 
  tab_header(title = "Demographics by experiment", subtitle = "Ethnicity")
```
<br>

### Country

```{r}
demo_country <- aah_summary |>
  mutate(experiment = paste0("Experiment ", experiment)) |> 
  group_by(experiment, country) |>
  summarize(n = n()) |>
  rename(Country = country)

demo_country |>
  pretty_table(groupname_col = "experiment") |> 
  tab_header(title = "Demographics by experiment", subtitle = "Country")
```
<br>

### EHI
```{r}
middle_purple1 <- "#996F91" ## In between plot colors one and two
fig_path_var <- here(fig_dir, "demo_ehi_dots_purple_e1.png")

if (use_cached_figs == F) {
  ehi_plot_data <- aah_summary |> filter(experiment == "one") |>  group_by(ehi) |> summarize(n = n())
  g <- gg_ehi_dotarea(ehi_plot_data, plot_color = middle_purple1,
                      cutoff = 40, cutoff_label_ypos = 120)
  g <- g + labs(title = "EHI distribution (Experiment 1)")
  ggsave(fig_path_var, g, "png", height = 3, width = 6)
}

include_graphics(fig_path_var)
```

```{r}
fig_path_var <- here(fig_dir, "demo_ehi_dots_purple_e2.png")

if (use_cached_figs == F) {
  ehi_plot_data <- aah_summary |> filter(experiment == "two") |>  group_by(ehi) |> summarize(n = n())
  g <- gg_ehi_dotarea(ehi_plot_data, plot_color = middle_purple1,
                      cutoff = 40, cutoff_label_ypos = 120)
  g <- g + labs(title = "EHI distribution (Experiment 2)")
  ggsave(fig_path_var, g, "png", height = 3, width = 6)
}

include_graphics(fig_path_var)
```

```{r}
fig_path_var <- here(fig_dir, "demo_ehi_dots_purple_e1-2.png")

if (use_cached_figs == F) {
  ehi_plot_data <- aah_summary |> group_by(ehi) |> summarize(n = n())
  g <- gg_ehi_dotarea(ehi_plot_data, plot_color = middle_purple1,
                      cutoff = 40, cutoff_label_ypos = 240,
                      group_label_ypos = 340,
                      y_lims = c(0, 400))
  g <- g + labs(title = "EHI distribution (Combining Experiments 1 and 2)")
  ggsave(fig_path_var, g, "png", height = 3, width = 6)
}

include_graphics(fig_path_var)
```

## Stats {.tabset .tabset-pills}

Test for an effect of experiment on the interaction of field by level, and on the effect of field (local).

`RT ~ field * level * handedness * experiment + (1|subject) + (1|shape)`

### Categorical handedness (primary) {.tabset}

```{r}
aah_cat <- aah_for_rt_model |> 
  filter(handedness %in% c("Right", "Left"))
```

#### Combine experiments

```{r}
MODEL_DESCRIPTION <- "Model: field * level * handedness (EHI +/-40) * experiment + (1|subject) + (1|shape)"

if (use_cached_models == FALSE) {
  rt_mm_cat <- lmer(
    data = aah_cat,
    formula = rt ~
      field * level * handedness * experiment
    + (1 | subject)
    + (1 | shape)
  )
  
  saveRDS(rt_mm_cat, here(manual_cache_dir, "rt_mm_cat.rds"))
} else if (use_cached_models == TRUE) {
  rt_mm_cat <- readRDS(here(manual_cache_dir, "rt_mm_cat.rds"))
}
```
<br>
```{r}
#### FxLxH (emmeans)
## Estimate effect of handedness on field x level with emmeans
## Use emmeans() to test 3-way interaction.
if (use_cached_models == FALSE) {
  rt_emm <- emmeans(
    rt_mm_cat,
    ~ field * level * handedness,
    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT
  )
  rt_interaction_emm <- rt_emm |>
    contrast(interaction = c("consec")) |>
    summary(infer = T)
  saveRDS(rt_interaction_emm,
          here(manual_cache_dir, "rt_interaction_emm_FLH.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_interaction_emm <-
    readRDS(here(manual_cache_dir, "rt_interaction_emm_FLH.rds"))
}

rt_interaction_emm |>
  as_tibble() |>
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by Level by Handedness (RT)"), 
             subtitle = "Compare effect estimate to zero with emmeans()") |>
  tab_footnote(footnote = "A positive number means RVF local bias is stronger in right handers (as predicted by AAH)",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = MODEL_DESCRIPTION,
               locations = cells_title()) |> 
  tab_footnote(footnote = "Two-sided",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>
```{r}
#### FxL | H
## Estimate the effect of field by level for each handedness group
if (use_cached_models == FALSE) {
  rt_emm <- emmeans(rt_mm_cat, ~field*level | handedness,
                    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT) |>
  contrast(interaction = "consec") |>
  summary(infer = T, adj = "none")
  
  saveRDS(rt_emm,
          here(manual_cache_dir, "rt_emm_FL_H.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emm <-
    readRDS(here(manual_cache_dir, "rt_emm_FL_H.rds"))
}

rt_emm |>
  as_tibble() |> 
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by Level (by Handedness) (RT)")) |> 
  tab_footnote(footnote = "A positive number means RVF>LVF local>global bias",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = MODEL_DESCRIPTION,
               locations = cells_title()) |> 
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>
```{r}
#### Field by handedness (by level)
## Estimate the effect of field by handedness, for each level
if (use_cached_models == FALSE) {
  rt_emm <- emmeans(rt_mm_cat,
                    ~ field * handedness | level,
                    lmer.df = DF_METHOD,
                    lmerTest.limit = LMERTEST_LIMIT) |>
    contrast(interaction = "consec") |>
    summary(infer = T, adj = "none")
  
  saveRDS(rt_emm,
          here(manual_cache_dir, "rt_emm_FH_L.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emm <-
    readRDS(here(manual_cache_dir, "rt_emm_FH_L.rds"))
}

rt_emm |>
  as_tibble() |> 
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by Handedness (by Level) (RT)")) |> 
  tab_footnote(footnote = "A positive number means greater RVF bias for right handers",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = MODEL_DESCRIPTION,
               locations = cells_title()) |> 
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>
```{r}
#### Field (by level, by handedness)
## Estimate the effect of field by level for each handedness group
if (use_cached_models == FALSE) {
  rt_emm <- emmeans(rt_mm_cat, ~field | handedness + level,
                    lmer.df = DF_METHOD,
                    lmerTest.limit = LMERTEST_LIMIT) |>
  contrast("revpairwise", by = c("handedness","level")) |>
  summary(infer = T, adj = "none")
  
  saveRDS(rt_emm,
          here(manual_cache_dir, "rt_emm_F_L_H.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emm <-
    readRDS(here(manual_cache_dir, "rt_emm_F_L_H.rds"))
}

rt_emm |>
  as_tibble() |> 
  format_p.value() |> 
  arrange(handedness, level) |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by (Handedness by Level) (RT)")) |> 
  tab_footnote(footnote = "A positive number means global bias (faster RT for global)",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = MODEL_DESCRIPTION,
               locations = cells_title()) |> 
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>

#### Compare experiments
<br>
```{r}
#### FxLxHxE (ANOVA)
## (ANOVA) Test for the effect of experiment (ANOVA model comparison)
## Here, we cannot model interactions higher-order than field x level x handedness
if (use_cached_models == FALSE) {

mm_no_interaction <- update(rt_mm_cat, . ~ . - field:level:handedness:experiment)

interaction_anova <- interaction_stats(rt_mm_cat, mm_no_interaction)

  saveRDS(interaction_anova, here(manual_cache_dir, "rt_mm_cat_anova_FLHE.rds"))
} else if (use_cached_models == TRUE) {
  interaction_anova <- readRDS(here(manual_cache_dir, "rt_mm_cat_anova_FLHE.rds"))
}

interaction_anova |>
  as_tibble() |>
  rename(p.value = `Pr(>Chisq)`) |> 
  format_p.value() |> 
  pretty_table() |> 
  tab_header(title = str_glue("{experiment_label}: Field by Handedness by Level (RT)"),
             subtitle = "ANOVA: compare models with vs. without interaction term") |> 
  tab_footnote(footnote = "F-test (two-sided? https://daniellakens.blogspot.com/2016/04/one-sided-f-tests-and-halving-p-values.html)",
               locations = cells_column_labels(columns = p.value))
```
<br>
```{r}
#### FxLxHxE (emmeans)
## Estimate effect of experiment on field x level x handedness with emmeans
## Use emmeans() to test 4-way interaction.
if (use_cached_models == FALSE) {
  rt_emm <-
    emmeans(rt_mm_cat, ~ field * level * handedness * experiment,
            lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT)
  rt_interaction_emm <- rt_emm |>
    contrast(interaction = c("consec")) |>
    summary(infer = T)
  
  saveRDS(rt_interaction_emm,
          here(manual_cache_dir, "rt_interaction_emm_FLHE.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_interaction_emm <-
    readRDS(here(manual_cache_dir, "rt_interaction_emm_FLHE.rds"))
}

rt_interaction_emm |>
  as_tibble() |>
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by Level by Handedness by Experiment (RT)"),
             subtitle = "Compare effect estimate to zero with emmeans()") |>
  tab_footnote(footnote = "A positive number means a greater effect in Experiment 2",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = MODEL_DESCRIPTION,
               locations = cells_title()) |> 
  tab_footnote(footnote = "Two-sided",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>
```{r}
#### FxHxE | L
## Estimate the effect of experiment on field*handedness, for each level. (i.e., does the effect of handedness on local hemifield bias differ by experiment?
if (use_cached_models == FALSE) {
  rt_emm <- emmeans(rt_mm_cat, ~ field * handedness * experiment | level,
                    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT)
  
  rt_interaction_emm <- rt_emm |> 
  contrast(interaction = c("consec")) |>
  summary(infer = T)

  
  saveRDS(rt_interaction_emm,
          here(manual_cache_dir, "rt_interaction_emm_FHE_L.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_interaction_emm <-
    readRDS(here(manual_cache_dir, "rt_interaction_emm_FHE_L.rds"))
}

rt_interaction_emm |>
  as_tibble() |>
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by Handedness by Experiment (by level) (RT)"),
             subtitle = "Compare effect estimate to zero with emmeans()") |>
  tab_footnote(footnote = "A positive number means the effect size is larger in Experiment 2",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = MODEL_DESCRIPTION,
               locations = cells_title()) |> 
  tab_footnote(footnote = "Two-sided",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>

### Categorical handedness (exploratory) {.tabset}

<br>
```{r}
aah_cat_zoom <- aah_for_rt_model |> 
  filter(handedness_extremes %in% c("Right", "Left")) |> 
  mutate(handedness = handedness_extremes)
```
<br>

#### Combine experiments

```{r}
MODEL_DESCRIPTION <- "Model: field * level * handedness (EHI +/-100) * experiment + (1|subject) + (1|shape)"

if (use_cached_models == FALSE) {
  rt_mm_cat_zoom <- lmer(
    data = aah_cat_zoom,
    formula = rt ~
      field * level * handedness * experiment
    + (1 | subject)
    + (1 | shape)
  )
  
  saveRDS(rt_mm_cat_zoom, here(manual_cache_dir, "rt_mm_cat_zoom.rds"))
} else if (use_cached_models == TRUE) {
  rt_mm_cat_zoom <- readRDS(here(manual_cache_dir, "rt_mm_cat_zoom.rds"))
}
```
<br>
```{r}
#### FxLxH (emmeans)
## Estimate effect of handedness on field x level with emmeans
## Use emmeans() to test 3-way interaction.
if (use_cached_models == FALSE) {
  rt_emm_zoom <- emmeans(
    rt_mm_cat_zoom,
    ~ field * level * handedness,
    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT
  )
  rt_interaction_emm_zoom <- rt_emm_zoom |>
    contrast(interaction = c("consec")) |>
    summary(infer = T)
  saveRDS(rt_interaction_emm_zoom,
          here(manual_cache_dir, "rt_interaction_emm_zoom_FLH.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_interaction_emm_zoom <-
    readRDS(here(manual_cache_dir, "rt_interaction_emm_zoom_FLH.rds"))
}

rt_interaction_emm_zoom |>
  as_tibble() |>
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by Level by Handedness (RT)"), 
             subtitle = "Compare effect estimate to zero with emmeans()") |>
  tab_footnote(footnote = "A positive number means RVF local bias is stronger in right handers (as predicted by AAH)",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = MODEL_DESCRIPTION,
               locations = cells_title()) |> 
  tab_footnote(footnote = "Two-sided",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>
```{r}
#### FxL | H
## Estimate the effect of field by level for each handedness group
if (use_cached_models == FALSE) {
  rt_emm_zoom <- emmeans(rt_mm_cat_zoom, ~field*level | handedness,
                    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT) |>
  contrast(interaction = "consec") |>
  summary(infer = T, adj = "none")
  
  saveRDS(rt_emm_zoom,
          here(manual_cache_dir, "rt_emm_zoom_FL_H.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emm_zoom <-
    readRDS(here(manual_cache_dir, "rt_emm_zoom_FL_H.rds"))
}

rt_emm_zoom |>
  as_tibble() |> 
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by Level (by Handedness) (RT)")) |> 
  tab_footnote(footnote = "A positive number means RVF>LVF local>global bias",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = MODEL_DESCRIPTION,
               locations = cells_title()) |> 
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>
```{r}
#### Field by handedness (by level)
## Estimate the effect of field by handedness, for each level
if (use_cached_models == FALSE) {
  rt_emm_zoom <- emmeans(rt_mm_cat_zoom,
                    ~ field * handedness | level,
                    lmer.df = DF_METHOD,
                    lmerTest.limit = LMERTEST_LIMIT) |>
    contrast(interaction = "consec") |>
    summary(infer = T, adj = "none")
  
  saveRDS(rt_emm_zoom,
          here(manual_cache_dir, "rt_emm_zoom_FH_L.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emm_zoom <-
    readRDS(here(manual_cache_dir, "rt_emm_zoom_FH_L.rds"))
}

rt_emm_zoom |>
  as_tibble() |> 
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by Handedness (by Level) (RT)")) |> 
  tab_footnote(footnote = "A positive number means greater RVF bias for right handers",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = MODEL_DESCRIPTION,
               locations = cells_title()) |> 
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>
```{r}
#### Field (by level, by handedness)
## Estimate the effect of field by level for each handedness group
if (use_cached_models == FALSE) {
  rt_emm_zoom <- emmeans(rt_mm_cat_zoom, ~field | handedness + level,
                    lmer.df = DF_METHOD,
                    lmerTest.limit = LMERTEST_LIMIT) |>
  contrast("revpairwise", by = c("handedness","level")) |>
  summary(infer = T, adj = "none")
  
  saveRDS(rt_emm_zoom,
          here(manual_cache_dir, "rt_emm_zoom_F_L_H.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emm_zoom <-
    readRDS(here(manual_cache_dir, "rt_emm_zoom_F_L_H.rds"))
}

rt_emm_zoom |>
  as_tibble() |> 
  format_p.value() |> 
  arrange(handedness, level) |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by (Handedness by Level) (RT)")) |> 
  tab_footnote(footnote = "A positive number means global bias (faster RT for global)",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = MODEL_DESCRIPTION,
               locations = cells_title()) |> 
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Two-sided, uncorrected",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>

#### Compare experiments

<br>
```{r}
#### FxLxHxE (ANOVA)
## (ANOVA) Test for the effect of experiment (ANOVA model comparison)
if (use_cached_models == FALSE) {

mm_no_interaction <- update(rt_mm_cat_zoom, . ~ . - field:level:handedness:experiment)

interaction_anova <- interaction_stats(rt_mm_cat_zoom, mm_no_interaction)

  saveRDS(interaction_anova, here(manual_cache_dir, "rt_mm_cat_anova_FLHE.rds"))
} else if (use_cached_models == TRUE) {
  interaction_anova <- readRDS(here(manual_cache_dir, "rt_mm_cat_anova_FLHE.rds"))
}

interaction_anova |>
  as_tibble() |>
  rename(p.value = `Pr(>Chisq)`) |> 
  format_p.value() |> 
  pretty_table() |> 
  tab_header(title = str_glue("{experiment_label}: Field by Handedness by Level (RT)"),
             subtitle = "ANOVA: compare models with vs. without interaction term") |> 
  tab_footnote(footnote = "F-test (two-sided? https://daniellakens.blogspot.com/2016/04/one-sided-f-tests-and-halving-p-values.html)",
               locations = cells_column_labels(columns = p.value))
```
<br>
```{r}
#### FxLxHxE (emmeans)
## Estimate effect of experiment on field x level x handedness with emmeans
## Use emmeans() to test 4-way interaction.
if (use_cached_models == FALSE) {
  rt_emm_zoom <-
    emmeans(rt_mm_cat_zoom, ~ field * level * handedness * experiment,
            lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT)
  rt_interaction_emm_zoom <- rt_emm_zoom |>
    contrast(interaction = c("consec")) |>
    summary(infer = T)
  
  saveRDS(rt_interaction_emm_zoom,
          here(manual_cache_dir, "rt_interaction_emm_zoom_FLHE.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_interaction_emm_zoom <-
    readRDS(here(manual_cache_dir, "rt_interaction_emm_zoom_FLHE.rds"))
}

rt_interaction_emm_zoom |>
  as_tibble() |>
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by Level by Handedness by Experiment (RT)"),
             subtitle = "Compare effect estimate to zero with emmeans()") |>
  tab_footnote(footnote = "A positive number means a greater effect in Experiment 2",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = MODEL_DESCRIPTION,
               locations = cells_title()) |> 
  tab_footnote(footnote = "Two-sided",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>
```{r}
#### FxHxE | L
## Estimate the effect of experiment on field*handedness, for each level. (i.e., does the effect of handedness on local hemifield bias differ by experiment?
if (use_cached_models == FALSE) {
  rt_emm_zoom <- emmeans(rt_mm_cat_zoom, ~ field * handedness * experiment | level,
                    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT)
  
  rt_interaction_emm_zoom <- rt_emm_zoom |> 
  contrast(interaction = c("consec")) |>
  summary(infer = T)

  
  saveRDS(rt_interaction_emm_zoom,
          here(manual_cache_dir, "rt_interaction_emm_zoom_FHE_L.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_interaction_emm_zoom <-
    readRDS(here(manual_cache_dir, "rt_interaction_emm_zoom_FHE_L.rds"))
}

rt_interaction_emm_zoom |>
  as_tibble() |>
  format_p.value() |> 
  pretty_table() |>
  tab_header(title = str_glue("{experiment_label}: Field by Handedness by Experiment (by level) (RT)"),
             subtitle = "Compare effect estimate to zero with emmeans()") |>
  tab_footnote(footnote = "A positive number means the effect size is larger in Experiment 2",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = MODEL_DESCRIPTION,
               locations = cells_title()) |> 
  tab_footnote(footnote = "Two-sided",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Confidence level: 95%",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>

### Continuous handedness (primary) {.tabset}

```{r}
## Relevel so that emmeans shows a positive number for RVF bias
aah_cont <- aah_for_rt_model |> 
  mutate(level = level |> factor(levels = c("Local", "Global")),
         field = field |> factor(levels = c("LVF", "RVF")),
         experiment = factor(experiment),
         )
```

```{r}
MODEL_DESCRIPTION <- "Model: field * level * EHI * experiment + (1|subject) + (1|shape)"

if (use_cached_models == FALSE) {
  rt_mm_cont <- lmer(
    data = aah_cont,
    formula = rt ~
      field * level * ehi * experiment
    + (1 | subject)
    + (1 | shape)
  )
  
  saveRDS(rt_mm_cont, here(manual_cache_dir, "rt_mm_cont.rds"))
} else if (use_cached_models == TRUE) {
  rt_mm_cont <- readRDS(here(manual_cache_dir, "rt_mm_cont.rds"))
}
```

#### Combine and compare experiments
<br>
```{r FxLxH}
#### FxLxH (emmeans)
if (use_cached_models == FALSE) {
  rt_emt <- emtrends(
    rt_mm_cont,
    pairwise ~ field * level,
    var = "ehi",
    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT
  )
  rt_interaction_emt <-
    rt_emt[[1]] |> contrast(interaction = c("consec"), var = "ehi") |>
    summary(infer = T)
  saveRDS(rt_interaction_emt,
          here(manual_cache_dir, "rt_interaction_emt_FLH.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_interaction_emt <-
    readRDS(here(manual_cache_dir, "rt_interaction_emt_FLH.rds"))
}


## Report interaction estimate, with CI and p value.
rt_interaction_emt |> 
  format_p.value() |> 
  pretty_table() |> 
  tab_header(title = str_glue("{experiment_label}: Field by Level by EHI (RT)"), 
             subtitle = "Compare effect estimate to zero with emmeans()") |>
  tab_footnote(footnote = "A positive number means local bias is stronger in RVF for right handers (as predicted by AAH), in ms per EHI unit (-100 to 100). Multiply this value by 200 to get the estimated difference in LVF global bias for strong left vs. right handers.",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = MODEL_DESCRIPTION,
               locations = cells_title()) |> 
  tab_footnote(footnote = "Two-sided",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Confidence level: 95",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>
```{r FxL_H}
## FxL | H (emmeans) (estimates at +/-100)
if (use_cached_models == FALSE) {

  rt_emt_FL_H <- rt_mm_cont |> 
  ref_grid(at = list(ehi = seq(-100, 100, 100)), lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT) |> 
  emmeans(~ field * level, by = "ehi", lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT) |> 
  contrast(interaction = c("consec"), by = c("ehi")) |> 
  summary(infer = T)
  
  saveRDS(rt_emt_FL_H,
          here(manual_cache_dir, "rt_emt_FL_H.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emt_FL_H <-
    readRDS(here(manual_cache_dir, "rt_emt_FL_H.rds"))
}

rt_emt_FL_H |> 
  as_tibble() |> 
  format_p.value() |>
  pretty_table() |>
  tab_header(title = "Field by level (by EHI)") |>
  tab_footnote(footnote = "Strong left hander: -100; Mixed hander: 0; Strong right hander: +100",
               locations = cells_column_labels(columns = ehi)) |>
  tab_footnote(footnote = "Estimated effect of field by level (ms); a positive number is in the direction of RVF local bias",
               locations = cells_column_labels(columns = estimate))
```
<br>
```{r FxLxHxE}
## FxLxHxE (emmeans)
if (use_cached_models == FALSE) {
  rt_emt_FLHE <- emtrends(
    rt_mm_cont,
    pairwise ~ field * level * experiment,
    var = "ehi",
    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT
  )
  rt_interaction_emt_FLHE <-
    rt_emt_FLHE[[1]] |> contrast(interaction = c("consec"), var = "ehi") |>
    summary(infer = T)
  saveRDS(rt_interaction_emt_FLHE,
          here(manual_cache_dir, "rt_interaction_emt_FLHE.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_interaction_emt_FLHE <-
    readRDS(here(manual_cache_dir, "rt_interaction_emt_FLHE.rds"))
}


## Report interaction estimate, with CI and p value.
rt_interaction_emt_FLHE |> 
  format_p.value() |> 
  pretty_table() |> 
  tab_header(title = str_glue("{experiment_label}: Field by Level by EHI (RT)"), 
             subtitle = "Compare effect estimate to zero with emmeans()") |>
  tab_footnote(footnote = "A positive number means the effect of handedness on field by level (in the direction predicted by AAH) was greater in experiment 2.",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = MODEL_DESCRIPTION,
               locations = cells_title()) |> 
  tab_footnote(footnote = "Two-sided",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Confidence level: 95",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>
```{r FxLxHxE_anova}
#### FxLxHxE (anova)
if (use_cached_models == FALSE) {
  mm_with_interaction <- rt_mm_cont
  mm_no_interaction <-
    update(mm_with_interaction, . ~ . - field:level:ehi:experiment)
  
  interaction_anova <-
    interaction_stats(mm_with_interaction, mm_no_interaction)
  
  saveRDS(interaction_anova,
          here(manual_cache_dir, "rt_mm_cont_anova_FLHE.rds"))
} else if (use_cached_models == TRUE) {
  interaction_anova <-
    readRDS(here(manual_cache_dir, "rt_mm_cont_anova_FLHE.rds"))
}

interaction_anova |>
  as_tibble() |>
  rename(p.value = `Pr(>Chisq)`) |>
  format_p.value() |>
  pretty_table() |>
  tab_header(title = "Field by level by EHI by experiment (RT)",
             subtitle = "ANOVA: compare models with vs. without interaction term") |>
  tab_footnote(footnote = MODEL_DESCRIPTION,
               locations = cells_title()) |> 
  tab_footnote(footnote = "F-test (two-sided? https://daniellakens.blogspot.com/2016/04/one-sided-f-tests-and-halving-p-values.html)",
               locations = cells_column_labels(columns = p.value))
```
<br>
```{r FxH_L}
if (use_cached_models == FALSE) {
  rt_emt <- emtrends(
    rt_mm_cont,
    pairwise ~ field,
    by = "level",
    var = "ehi",
    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT
  ) |> summary(infer = T)
  
  rt_emt <- rt_emt$contrasts
  
  saveRDS(rt_emt,
          here(manual_cache_dir, "rt_interaction_emt_FH_L.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emt <-
    readRDS(here(manual_cache_dir, "rt_interaction_emt_FH_L.rds"))
}


## Report interaction estimate, with CI and p value.
rt_emt |> 
  format_p.value() |> 
  pretty_table() |> 
  tab_header(title = str_glue("{experiment_label}: Field by EHI (by Level) (RT)"), 
             subtitle = "Compare effect estimate to zero with emmeans()") |>
  tab_footnote(footnote = "A positive number means local bias is stronger in RVF for right handers (as predicted by AAH), in ms per EHI unit (-100 to 100). Multiply this value by 200 to get the estimated difference in LVF global bias for strong left vs. right handers.",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = MODEL_DESCRIPTION,
               locations = cells_title()) |> 
  tab_footnote(footnote = "Two-sided",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Confidence level: 95",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))
```
<br>
```{r F | L | H}
## FxL | H (emmeans) (estimates at +/-100)
if (use_cached_models == FALSE) {

  rt_emt_F_L_H <- rt_mm_cont |> 
  ref_grid(at = list(ehi = seq(-100, 100, 100)), lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT) |> 
  emmeans(~ field, by = c("level", "ehi"), lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT) |> 
  contrast("pairwise", by = c("level", "ehi")) |> 
  summary(infer = T)
  
  saveRDS(rt_emt_F_L_H,
          here(manual_cache_dir, "rt_emt_F_L_H.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_emt_F_L_H <-
    readRDS(here(manual_cache_dir, "rt_emt_F_L_H.rds"))
}

rt_emt_F_L_H |> 
  as_tibble() |> 
  format_p.value() |>
  pretty_table() |>
  tab_header(title = "Field (by level, by EHI)") |>
  tab_footnote(footnote = "Strong left hander: -100; Mixed hander: 0; Strong right hander: +100",
               locations = cells_column_labels(columns = ehi)) |>
  tab_footnote(footnote = "Estimated effect of field (ms); a positive number is in the direction of RVF bias",
               locations = cells_column_labels(columns = estimate))
```
<br>
```{r FxHxE_L}
#### FxHxE | L
if (use_cached_models == FALSE) {
  rt_emt_FHE_L <- emtrends(
    rt_mm_cont,
    pairwise ~ field * experiment,
    by = "level",
    var = "ehi",
    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT
  )
  
  rt_interaction_emt_FHE_L <-
    rt_emt_FHE_L[[1]] |> contrast(interaction = c("consec"), var = "ehi") |>
    summary(infer = T)
  saveRDS(rt_interaction_emt_FHE_L,
          here(manual_cache_dir, "rt_interaction_emt_FHE_L.rds"))
} else if (use_cached_models == TRUE) {
  ## Load cached model
  rt_interaction_emt_FHE_L <-
    readRDS(here(manual_cache_dir, "rt_interaction_emt_FHE_L.rds"))
}


## Report interaction estimate, with CI and p value.
rt_interaction_emt_FHE_L |> 
  format_p.value() |> 
  pretty_table() |> 
  tab_header(title = str_glue("{experiment_label}: Field by EHI by Experiment (by level) (RT)"), 
             subtitle = "Compare effect estimate to zero with emmeans()") |>
  tab_footnote(footnote = "A positive number means the effect of handedness on field by level (in the direction predicted by AAH) was greater in experiment 2.",
               locations = cells_column_labels(columns = estimate)) |>
  tab_footnote(footnote = MODEL_DESCRIPTION,
               locations = cells_title()) |> 
  tab_footnote(footnote = "Two-sided",
               locations = cells_column_labels(columns = p.value)) |>
  tab_footnote(footnote = "Confidence level: 95",
               locations = cells_column_labels(columns = ends_with("CL"))) |>
  tab_footnote(footnote = "Z-approximation",
               locations = cells_column_labels(columns = df))

```

## Plots {.tabset .tabset-pills}

```{r}
DEFAULT_HEIGHT = 3
DEFAULT_WIDTH = 5
```

Diamonds and lineranges show mixed-effects model point estimates and 95% CI.

### Categorical handedness (primary) {.tabset}

```{r}
fig_path_var <- here(fig_dir, "rt_1_lmer_E1.png")
fig_path_var_wide <- here(fig_dir, "rt_1_lmer_wide_E1.png")


if (use_cached_figs == F) {
  # rt_mm_cat <- readRDS(here(manual_cache_dir, "rt_mm_cat.rds"))
  model_data <- aah_cat |> filter(experiment == "one")
  plot_model <- lmer(
    data = model_data,
    formula = rt ~
      field * level * handedness
    + (1 | subject)
    + (1 | shape)
  )
  rt_emm <- emmeans(plot_model, ~ field * level * handedness,
                    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT)

  ## Get estimates for right and left handers.
  emm_data <- rt_emm |>
    contrast("pairwise", by = c("handedness", "level")) |>
    summary(infer = T, level = .95) |>
    as_tibble() |>
    ## Fix units
    mutate(
      estimate = estimate * -1,
      lower.CL = lower.CL * -1,
      upper.CL = upper.CL * -1
    )


  plot_data <- emm_data |> mutate(dv = estimate)

  ## Extract n's (MANUALLY COUNT N IN DATAFRAME USED IN MODEL)
  n_left <- model_data |> group_by(subject, handedness) |>  count() |>
    group_by(handedness) |> count() |>
    filter(handedness == "Left") |> pull(n)

  n_right <- model_data |> group_by(subject, handedness) |>  count() |>
    group_by(handedness) |> count() |>
    filter(handedness == "Right") |> pull(n)

  g <- gg_rt_2_lmer(
    # title = "Experiment 1:\n Hemifield bias by level (EHI cut at +/-40)",
    title = "Hemifield bias by level (EHI cut at +/-40)",
    plot_data,
    handedness_labeller = NULL,
    plot_colors = plot_colors,
    direction_labels = list(right = "RVF bias",
                            left = "LVF bias"),
    direction_labels_pos = list(right = 38,
                                left = -38),
    xlims = list(upper = 38,
                 lower = -38),
    xbreaks = list(major = 10,
                   minor = 5),
    n_subjects = list(right = n_right,
                      left = n_left)
  )
  
  
  g <- g + labs(subtitle = "Experiment 1") +
    theme(plot.title = element_text(hjust = .5),
          plot.subtitle = element_text(hjust = .5, face = "italic")
    )

  ggsave(fig_path_var, g, "png", height = DEFAULT_HEIGHT, width = DEFAULT_WIDTH)
}

include_graphics(fig_path_var)
```
<br>
```{r}
fig_path_var <- here(fig_dir, "rt_1_lmer_E2.png")
fig_path_var_wide <- here(fig_dir, "rt_1_lmer_wide_E2.png")


if (use_cached_figs == F) {
  # rt_mm_cat <- readRDS(here(manual_cache_dir, "rt_mm_cat.rds"))
  model_data <- aah_cat |> filter(experiment == "two")
  plot_model <- lmer(
    data = model_data,
    formula = rt ~
      field * level * handedness
    + (1 | subject)
    + (1 | shape)
  )
  rt_emm <- emmeans(plot_model, ~ field * level * handedness,
                    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT)

  ## Get estimates for right and left handers.
  emm_data <- rt_emm |>
    contrast("pairwise", by = c("handedness", "level")) |>
    summary(infer = T, level = .95) |>
    as_tibble() |>
    ## Fix units
    mutate(
      estimate = estimate * -1,
      lower.CL = lower.CL * -1,
      upper.CL = upper.CL * -1
    )


  plot_data <- emm_data |> mutate(dv = estimate)

  ## Extract n's (MANUALLY COUNT N IN DATAFRAME USED IN MODEL)
  n_left <- model_data |> group_by(subject, handedness) |>  count() |>
    group_by(handedness) |> count() |>
    filter(handedness == "Left") |> pull(n)

  n_right <- model_data |> group_by(subject, handedness) |>  count() |>
    group_by(handedness) |> count() |>
    filter(handedness == "Right") |> pull(n)

  g <- gg_rt_2_lmer(
    # title = "Experiment 2:\n Hemifield bias by level (EHI cut at +/-40)",
    title = "Hemifield bias by level (EHI cut at +/-40)",
    plot_data,
    handedness_labeller = NULL,
    plot_colors = plot_colors,
   direction_labels = list(right = "RVF bias",
                          left = "LVF bias"),
  direction_labels_pos = list(right = 38,
                              left = -38),
    xlims = list(upper = 38,
                 lower = -38),
    xbreaks = list(major = 10,
                   minor = 5),
    n_subjects = list(right = n_right,
                      left = n_left)
  )
  
  g <- g + labs(subtitle = "Experiment 2") +
    theme(plot.title = element_text(hjust = .5),
          plot.subtitle = element_text(hjust = .5, face = "italic")
    )

  ggsave(fig_path_var, g, "png", height = DEFAULT_HEIGHT, width = DEFAULT_WIDTH)
}

include_graphics(fig_path_var)
```
<br>
```{r}
fig_path_var <- here(fig_dir, "rt_1_lmer_E1-2.png")
fig_path_var_wide <- here(fig_dir, "rt_1_lmer_wide_E1-2.png")

if (use_cached_figs == F) {
  model_data <- aah_cat
  plot_model <- lmer(
    data = model_data,
    formula = rt ~
      field * level * handedness * experiment
    + (1 | subject)
    + (1 | shape)
  )
  rt_emm <- emmeans(plot_model, ~ field * level * handedness,
                    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT)
  
  ## Get estimates for right and left handers.
  emm_data <- rt_emm |>
    contrast("pairwise", by = c("handedness", "level")) |>
    summary(infer = T, level = .95) |>
    as_tibble() |>
    ## Fix units
    mutate(
      estimate = estimate * -1,
      lower.CL = lower.CL * -1,
      upper.CL = upper.CL * -1
    )
  
  
  plot_data <- emm_data |> mutate(dv = estimate)
  
  ## Extract n's (MANUALLY COUNT N IN DATAFRAME USED IN MODEL)
  n_left <- model_data |> group_by(subject, handedness) |>  count() |>
    group_by(handedness) |> count() |>
    filter(handedness == "Left") |> pull(n)
  
  n_right <- model_data |> group_by(subject, handedness) |>  count() |>
    group_by(handedness) |> count() |>
    filter(handedness == "Right") |> pull(n)
  
  g <- gg_rt_2_lmer(
    # title = "Experiments 1 and 2 combined:\n Hemifield bias by level (EHI cut at +/-40)",
    title = "Hemifield bias by level (EHI cut at +/-40)",
    plot_data,
    handedness_labeller = NULL,
    plot_colors = plot_colors,
    direction_labels = list(right = "RVF bias",
                            left = "LVF bias"),
    direction_labels_pos = list(right = 38,
                                left = -38),
    xlims = list(upper = 38,
                 lower = -38),
    xbreaks = list(major = 10,
                   minor = 5),
    n_subjects = list(right = n_right,
                      left = n_left)
  )
  
  g <- g + labs(subtitle = "Experiments 1 & 2 combined") +
    theme(plot.title = element_text(hjust = .5),
          plot.subtitle = element_text(hjust = .5, face = "italic")
    )
  
  ggsave(fig_path_var, g, "png", height = DEFAULT_HEIGHT, width = DEFAULT_WIDTH)
}

include_graphics(fig_path_var)
```
<br>

### Categorical handedness (exploratory) {.tabset}
```{r}
## Start over, with numeric y axis
## Add a line with CI from the model
fig_path_var <- here(fig_dir, "rt_1_lmer_E1_zoom.png")
fig_path_var_wide <- here(fig_dir, "rt_1_lmer_wide_E1_zoom.png")

if (use_cached_figs == F) {
  # rt_mm_cat <- readRDS(here(manual_cache_dir, "rt_mm_cat.rds"))
  model_data <- aah_cat_zoom |> filter(experiment == "one")
  plot_model <- lmer(
    data = model_data,
    formula = rt ~
      field * level * handedness
    + (1 | subject)
    + (1 | shape)
  )
  rt_emm <- emmeans(plot_model, ~ field * level * handedness,
                    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT)

  ## Get estimates for right and left handers.
  emm_data <- rt_emm |>
    contrast("pairwise", by = c("handedness", "level")) |>
    summary(infer = T, level = .95) |>
    as_tibble() |>
    ## Fix units
    mutate(
      estimate = estimate * -1,
      lower.CL = lower.CL * -1,
      upper.CL = upper.CL * -1
    )


  plot_data <- emm_data |> mutate(dv = estimate)

  ## Extract n's (MANUALLY COUNT N IN DATAFRAME USED IN MODEL)
  n_left <- model_data |> group_by(subject, handedness) |>  count() |>
    group_by(handedness) |> count() |>
    filter(handedness == "Left") |> pull(n)

  n_right <- model_data |> group_by(subject, handedness) |>  count() |>
    group_by(handedness) |> count() |>
    filter(handedness == "Right") |> pull(n)

  g <- gg_rt_2_lmer(
    # title = "Experiment 1:\n Hemifield bias by level (EHI cut at +/-100)",
    title = "Hemifield bias by level (EHI cut at +/-100)",
    plot_data,
    handedness_labeller = NULL,
    plot_colors = plot_colors,
    direction_labels = list(right = "RVF bias",
                            left = "LVF bias"),
    direction_labels_pos = list(right = 38,
                                left = -38),
    xlims = list(upper = 38,
                 lower = -38),
    xbreaks = list(major = 10,
                   minor = 5),
    n_subjects = list(right = n_right,
                      left = n_left)
  )

  g <- g + labs(subtitle = "Experiment 1") +
    theme(plot.title = element_text(hjust = .5),
          plot.subtitle = element_text(hjust = .5, face = "italic")
    )
  ggsave(fig_path_var, g, "png", height = DEFAULT_HEIGHT, width = DEFAULT_WIDTH)
}

include_graphics(fig_path_var)
```
<br>
```{r}
## Start over, with numeric y axis
## Add a line with CI from the model
fig_path_var <- here(fig_dir, "rt_1_lmer_E2_zoom.png")
fig_path_var_wide <- here(fig_dir, "rt_1_lmer_wide_E2_zoom.png")


if (use_cached_figs == F) {
  # rt_mm_cat <- readRDS(here(manual_cache_dir, "rt_mm_cat.rds"))
  model_data <- aah_cat_zoom |> filter(experiment == "two")
  plot_model <- lmer(
    data = model_data,
    formula = rt ~
      field * level * handedness
    # + (1 | subject) ## Does not converge with this term (max|grad| = 0.04)
    + (1 | shape)
  )
  rt_emm <- emmeans(plot_model, ~ field * level * handedness,
                    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT)

  ## Get estimates for right and left handers.
  emm_data <- rt_emm |>
    contrast("pairwise", by = c("handedness", "level")) |>
    summary(infer = T, level = .95) |>
    as_tibble() |>
    ## Fix units
    mutate(
      estimate = estimate * -1,
      lower.CL = lower.CL * -1,
      upper.CL = upper.CL * -1
    )

  plot_data <- emm_data |> mutate(dv = estimate)

  ## Extract n's (MANUALLY COUNT N IN DATAFRAME USED IN MODEL)
  n_left <- model_data |> group_by(subject, handedness) |>  count() |>
    group_by(handedness) |> count() |>
    filter(handedness == "Left") |> pull(n)

  n_right <- model_data |> group_by(subject, handedness) |>  count() |>
    group_by(handedness) |> count() |>
    filter(handedness == "Right") |> pull(n)

  g <- gg_rt_2_lmer(
    # title = "Experiment 2:\n Hemifield bias by level (EHI cut at +/-100)",
    title = "Hemifield bias by level (EHI cut at +/-100)",
    plot_data,
    handedness_labeller = NULL,
    plot_colors = plot_colors,
    direction_labels = list(right = "RVF bias",
                            left = "LVF bias"),
    direction_labels_pos = list(right = 38,
                                left = -38),
    xlims = list(upper = 38,
                 lower = -38),
    xbreaks = list(major = 10,
                   minor = 5),
    n_subjects = list(right = n_right,
                      left = n_left)
  )
  
  g <- g + labs(subtitle = "Experiment 2") +
    theme(
      plot.title = element_text(hjust = .5),
      plot.subtitle = element_text(hjust = .5, face = "italic")
    )

  ggsave(fig_path_var, g, "png", height = DEFAULT_HEIGHT, width = DEFAULT_WIDTH)
}

include_graphics(fig_path_var)
```
<br>
```{r}
## Start over, with numeric y axis
## Add a line with CI from the model
fig_path_var <- here(fig_dir, "rt_1_lmer_E1-2_zoom.png")
fig_path_var_wide <- here(fig_dir, "rt_1_lmer_wide_E1-2_zoom.png")

if (use_cached_figs == F) {
  model_data <- aah_cat_zoom
  plot_model <- lmer(
    data = model_data,
    formula = rt ~
      field * level * handedness * experiment
    + (1 | subject)
    + (1 | shape)
  )
  rt_emm <- emmeans(plot_model, ~ field * level * handedness,
                    lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT)

  ## Get estimates for right and left handers.
  emm_data <- rt_emm |>
    contrast("pairwise", by = c("handedness", "level")) |>
    summary(infer = T, level = .95) |>
    as_tibble() |>
    ## Fix units
    mutate(
      estimate = estimate * -1,
      lower.CL = lower.CL * -1,
      upper.CL = upper.CL * -1
    )
  
  
  plot_data <- emm_data |> mutate(dv = estimate)
  
  ## Extract n's (MANUALLY COUNT N IN DATAFRAME USED IN MODEL)
  n_left <- model_data |> group_by(subject, handedness) |>  count() |>
    group_by(handedness) |> count() |>
    filter(handedness == "Left") |> pull(n)
  
  n_right <- model_data |> group_by(subject, handedness) |>  count() |>
    group_by(handedness) |> count() |>
    filter(handedness == "Right") |> pull(n)
  
  g <- gg_rt_2_lmer(
    # title = "Experiments 1 and 2 combined:\n Hemifield bias by level (EHI cut at +/-100)",
    title = "Hemifield bias by level (EHI cut at +/-100)",
    plot_data,
    handedness_labeller = NULL,
    plot_colors = plot_colors,
    direction_labels = list(right = "RVF bias",
                            left = "LVF bias"),
    direction_labels_pos = list(right = 38,
                                left = -38),
    xlims = list(upper = 38,
                 lower = -38),
    xbreaks = list(major = 10,
                   minor = 5),
    n_subjects = list(right = n_right,
                      left = n_left)
  )
  
  g <- g + labs(subtitle = "Experiments 1 & 2 combined") +
    theme(
      plot.title = element_text(hjust = .5),
      plot.subtitle = element_text(hjust = .5, face = "italic")
    )
  
  ggsave(fig_path_var, g, "png", height = DEFAULT_HEIGHT, width = DEFAULT_WIDTH)
}

include_graphics(fig_path_var)
```
<br>

### Continuous handedness (primary) {.tabset}

```{r plot_rt_cor_bins_config}
# plot_color = plot_blue
middle_purple1 <- "#996F91" ## In between plot colors one and two
middle_purple2 <- "#886e92" ## In between plot colors one and two
plot_color <- middle_purple1

h_plot_colors <- c(plot_colors[[1]], middle_purple1, plot_colors[[2]])
```
<br>
```{r}
## Experiment 1
## Plot correlation for local and global shapes (facets)
## Add a line with CI from the model
fig_path_var <- here(fig_dir, "rt_2_cor_line_E1.png")
fig_path_var_wide <- here(fig_dir, "rt_2_cor_line_E1.png")

if (use_cached_figs == F) {
## Extract line of best fit, confidence bounds from model.

  rt_model_ehi <- lmer(
    data = aah_cont |> filter(experiment == "one"),
    formula = rt ~
      field * level * ehi 
    + (1 | subject)
    + (1 | shape)
  )

line_data <- rt_model_ehi |> 
  ref_grid(at = list(ehi = seq(-100, 100, 12.5)),
           lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT) |> 
  emmeans(~ field * ehi, by = "level",
          lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT) |> 
  contrast(interaction = c("consec"), by = c("ehi", "level"), level = .95) |> 
  summary(infer = T) |> 
  as_tibble()

rt_subject_sub <- rt_subject |> filter(experiment == "one")
rt_subject_plot <- rt_subject_sub |>
  pivot_wider(names_from = c(field),
              values_from = rt) |>
   mutate(LVF_Bias = RVF - LVF) |> 
  left_join(aah_summary, by = c("subject", "handedness")) |>
  select(subject, level, ehi, starts_with("LVF"), handedness, handedness_extremes) |> 
  ## Set "dv" here to make it easy to write a reusable function
  mutate(dv = LVF_Bias) |> 
  ungroup()

n_subjects <- rt_subject_sub |> group_by(subject) |> count() |> group_by(subject) |> pull(subject) |> length() |> 
  format(nsmall = 0, big.mark = ",")
  
  g <-
    gg_rt_2_line(
      title = "Frequency specialization by handedness (continuous)",
      y_title = "RVF - LVF reaction time (ms)",
      rt_subject_plot = rt_subject_plot,
      plot_colors = h_plot_colors,
      plot_color = plot_color,
      group_by_level = T,
      direction_labels = list(
        up = "LVF Bias",
        down = "RVF Bias"),
      direction_labels_pos = list(
        up = 38,
        down = -38),
      ylims = list(
        upper = 40,
        lower = -40),
      ybreaks = list(
        major = 10,
        minor = 5)
    ) |>
    gg_style_cor_bin()
  
  g <- g +
  geom_line(data = line_data,
            aes(y = estimate)) +
    geom_ribbon(data = line_data,
                inherit.aes = F,
              aes(x = ehi, ymin = lower.CL, ymax = upper.CL),
              fill = plot_color,
              alpha = .2)
  
  g <- g + facet_wrap(~ level, nrow = 1)
  
  g <- g + labs(subtitle = glue("Experiment 1 (n = ", n_subjects, ")")) +
    theme(plot.title = element_text(hjust = .5),
          plot.subtitle = element_text(hjust = .5, face = "italic")
    )
  
  ggsave(fig_path_var, g, "png", height = 4, width = 4)
  ggsave(fig_path_var_wide, g, "png", height = 4, width = 8)
  
}

include_graphics(fig_path_var)
```
<br>
```{r}
## Experiment 2
## Plot correlation for local and global shapes (facets)
## Add a line with CI from the model
fig_path_var <- here(fig_dir, "rt_2_cor_line_E2.png")
fig_path_var_wide <- here(fig_dir, "rt_2_cor_line_E2.png")

if (use_cached_figs == F) {
## Extract line of best fit, confidence bounds from model.

  rt_model_ehi <- lmer(
    data = aah_cont |> filter(experiment == "two"),
    formula = rt ~
      field * level * ehi 
    + (1 | subject)
    + (1 | shape)
  )

line_data <- rt_model_ehi |> 
  ref_grid(at = list(ehi = seq(-100, 100, 12.5)),
           lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT) |> 
  emmeans(~ field * ehi, by = "level",
          lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT) |> 
  contrast(interaction = c("consec"), by = c("ehi", "level"), level = .95) |> 
  summary(infer = T) |> 
  as_tibble()

rt_subject_sub <- rt_subject |> filter(experiment == "two")
rt_subject_plot <- rt_subject_sub |>
  pivot_wider(names_from = c(field),
              values_from = rt) |>
   mutate(LVF_Bias = RVF - LVF) |> 
  left_join(aah_summary, by = c("subject", "handedness")) |>
  select(subject, level, ehi, starts_with("LVF"), handedness, handedness_extremes) |> 
  ## Set "dv" here to make it easy to write a reusable function
  mutate(dv = LVF_Bias) |> 
  ungroup()

n_subjects <- rt_subject_sub |> group_by(subject) |> count() |> group_by(subject) |> pull(subject) |> length() |> 
  format(nsmall=0, big.mark=",")
  
  g <-
    gg_rt_2_line(
      title = "Frequency specialization by handedness (continuous)",
      y_title = "RVF - LVF reaction time (ms)",
      rt_subject_plot = rt_subject_plot,
      plot_colors = h_plot_colors,
      plot_color = plot_color,
      group_by_level = T,
      direction_labels = list(
        up = "LVF Bias",
        down = "RVF Bias"),
      direction_labels_pos = list(
        up = 38,
        down = -68),
      ylims = list(
        upper = 40,
        lower = -70),
      ybreaks = list(
        major = 10,
        minor = 5)
    ) |>
    gg_style_cor_bin()
  
  g <- g +
  geom_line(data = line_data,
            aes(y = estimate)) +
    geom_ribbon(data = line_data,
                inherit.aes = F,
              aes(x = ehi, ymin = lower.CL, ymax = upper.CL),
              fill = plot_color,
              alpha = .2)
  
  g <- g + facet_wrap(~ level, nrow = 1)
  
  g <- g + labs(subtitle = glue("Experiment 2 (n = ", n_subjects, ")")) +
    theme(plot.title = element_text(hjust = .5),
          plot.subtitle = element_text(hjust = .5, face = "italic")
    )
  
  ggsave(fig_path_var, g, "png", height = 4, width = 4)
  ggsave(fig_path_var_wide, g, "png", height = 4, width = 8)
  
}

include_graphics(fig_path_var)
```
<br>
```{r}
## Experiments 1 and 2
## Plot correlation for local and global shapes (facets)
## Add a line with CI from the model
fig_path_var <- here(fig_dir, "rt_2_cor_line_E1-2.png")
fig_path_var_wide <- here(fig_dir, "rt_2_cor_line_E1-2.png")

if (use_cached_figs == F) {

  
  if (use_cached_models == FALSE) {


  
## Extract line of best fit, confidence bounds from model.
rt_model_ehi <- readRDS(here(manual_cache_dir, "rt_mm_cont.rds"))


line_data <- rt_model_ehi |> 
  ref_grid(at = list(ehi = seq(-100, 100, 12.5)),
           lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT) |> 
  emmeans(~ field * ehi, by = "level",
          lmer.df = DF_METHOD,
    lmerTest.limit = LMERTEST_LIMIT) |> 
  contrast(interaction = c("consec"), by = c("ehi", "level"), level = .95) |> 
  summary(infer = T) |> 
  as_tibble()

  saveRDS(line_data, here(manual_cache_dir, "rt_plotdata_cont_e1-2.rds"))
} else if (use_cached_models == TRUE) {
  line_data <- readRDS(here(manual_cache_dir, "rt_plotdata_cont_e1-2.rds"))
}


# ref <- ref_grid(rt_model_ehi, at = list(ehi = seq(-100, 100, 12.5)))
# line_data <- ref |> contrast(interaction = c("consec"), by = "ehi", level = .95) |>
#   summary(infer = T) |>
#   as_tibble()

rt_subject_plot <- rt_subject |>
  pivot_wider(names_from = c(field, level),
              values_from = rt) |>
  mutate(LVF_Global_Bias = (RVF_Global - RVF_Local) - (LVF_Global - LVF_Local)) |>
  left_join(aah_summary, by = c("subject", "handedness")) |>
  select(subject, ehi, starts_with("LVF"), handedness, handedness_extremes) |>
  ## Set "dv" here to make it easy to write a reusable function
  mutate(dv = LVF_Global_Bias) |>
  ungroup()

rt_subject_plot <- rt_subject |>
  pivot_wider(names_from = c(field),
              values_from = rt) |>
   mutate(LVF_Bias = RVF - LVF) |> 
  left_join(aah_summary, by = c("subject", "handedness")) |>
  select(subject, level, ehi, starts_with("LVF"), handedness, handedness_extremes) |> 
  ## Set "dv" here to make it easy to write a reusable function
  mutate(dv = LVF_Bias) |> 
  ungroup()

n_subjects <- rt_subject |> group_by(subject) |> count() |> group_by(subject) |> pull(subject) |> length() |> 
  format(nsmall=0, big.mark=",")

  
  g <-
    gg_rt_2_line(
      title = "Frequency specialization by handedness (continuous)",
      y_title = "RVF - LVF reaction time (ms)",
      rt_subject_plot = rt_subject_plot,
      plot_colors = h_plot_colors,
      plot_color = plot_color,
      group_by_level = T,
      direction_labels = list(
        up = "LVF Bias",
        down = "RVF Bias"),
      direction_labels_pos = list(
        up = 38,
        down = -38),
      ylims = list(
        upper = 40,
        lower = -40),
      ybreaks = list(
        major = 10,
        minor = 5)
    ) |>
    gg_style_cor_bin()
  
  g <- g +
  geom_line(data = line_data,
            aes(y = estimate)) +
    geom_ribbon(data = line_data,
                inherit.aes = F,
              aes(x = ehi, ymin = lower.CL, ymax = upper.CL),
              fill = plot_color,
              alpha = .2)
  
  g <- g + facet_wrap(~ level, nrow = 1)
  
  g <- g + labs(subtitle = glue("Experiments 1 & 2 combined (n = ", n_subjects, ")")) +
    theme(plot.title = element_text(hjust = .5),
          plot.subtitle = element_text(hjust = .5, face = "italic")
    )
  
  ggsave(fig_path_var, g, "png", height = 4, width = 4)
  ggsave(fig_path_var_wide, g, "png", height = 4, width = 8)
}

include_graphics(fig_path_var)
```
<br>
